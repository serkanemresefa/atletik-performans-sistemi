<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Atletik Performans Takip Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header, .team-management { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { color: #4a5568; margin-bottom: 10px; text-align: center; }
        .team-selector-container { display: flex; gap: 10px; align-items: center; margin-top: 15px; flex-wrap: wrap; }
        .nav-tabs { display: flex; background: white; border-radius: 10px; padding: 5px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .nav-tab { flex: 1; padding: 12px 16px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #4a5568; }
        .form-control { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-control:focus { outline: none; border-color: #667eea; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: transform 0.2s ease; }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .table-container { background: #f7fafc; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .table th { background: #edf2f7; font-weight: 600; }
        .chart-container { height: 400px; margin: 20px 0; }
        .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        @media (max-width: 768px) { .nav-tabs, .team-selector-container { flex-direction: column; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ Atletik Performans Takip Sistemi</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div class="team-selector-container">
                    <label for="team-select" style="font-weight: 500;">Takƒ±m Se√ß:</label>
                    <select id="team-select" class="form-control" onchange="handleTeamChange()" style="min-width: 200px;"></select>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="user-info" style="color: #4a5568; font-weight: 500;"></span>
                    <button onclick="logout()" class="btn" style="padding: 8px 16px; font-size: 14px;">üö™ √áƒ±kƒ±≈ü</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('team-dashboard')">üèÜ Dashboard</button>
            <button class="nav-tab" onclick="showTab('team-management')">üõ†Ô∏è Takƒ±m Y√∂netimi</button>
            <button class="nav-tab" onclick="showTab('players')">üë• Oyuncular</button>
            <button class="nav-tab" onclick="showTab('data-entry')">‚ûï Veri Giri≈üi</button>
            <button class="nav-tab" onclick="showTab('analysis')">üìà Analiz</button>
        </div>

        <!-- Team Dashboard Tab -->
        <div id="team-dashboard" class="tab-content active">
            <h2 id="dashboard-title">üèÜ Takƒ±m Performans √ñzeti</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="total-players">-</div><div>Toplam Oyuncu</div></div>
                <div class="stat-card"><div class="stat-number" id="total-activities">-</div><div>Toplam Aktivite</div></div>
                <div class="stat-card"><div class="stat-number" id="total-trainings">-</div><div>Antrenman Sayƒ±sƒ±</div></div>
                <div class="stat-card"><div class="stat-number" id="total-matches">-</div><div>Ma√ß Sayƒ±sƒ±</div></div>
            </div>
            <div class="table-container">
                <h3>üïê Son Aktiviteler</h3>
                <table class="table"><thead><tr><th>Tarih</th><th>Oyuncu</th><th>T√ºr</th><th>Mesafe (m)</th><th>S√ºre (dk)</th></tr></thead><tbody id="recent-activities"></tbody></table>
            </div>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content">
            <h2>üë• Oyuncu Y√∂netimi</h2>
            <div id="player-alert"></div>
            <form id="player-form">
                <div class="form-row">
                    <div class="form-group"><label for="player-name">Oyuncu Adƒ±</label><input type="text" id="player-name" class="form-control" required></div>
                    <div class="form-group"><label for="player-position">Pozisyon</label><select id="player-position" class="form-control" required><option value="Forward">Forvet</option><option value="Midfielder">Orta Saha</option><option value="Defender">Defans</option><option value="Goalkeeper">Kaleci</option></select></div>
                </div>
                <button type="submit" class="btn">‚ûï Oyuncu Ekle</button>
            </form>
            <div class="table-container">
                <h3>üìã Mevcut Oyuncular</h3>
                <table class="table"><thead><tr><th>Oyuncu Adƒ±</th><th>Pozisyon</th><th>Kayƒ±t Tarihi</th></tr></thead><tbody id="players-table"></tbody></table>
            </div>
        </div>

        <!-- Data Entry Tab -->
        <div id="data-entry" class="tab-content">
            <h2>‚ûï G√ºnl√ºk Veri Giri≈üi</h2>
            <div id="data-entry-alert"></div>
            <form id="activity-form">
                <div class="form-row">
                    <div class="form-group"><label for="player-select">Oyuncu Se√ßin</label><select id="player-select" class="form-control" required></select></div>
                    <div class="form-group"><label for="activity-date">Tarih</label><input type="date" id="activity-date" class="form-control" required></div>
                    <div class="form-group"><label for="activity-type">Aktivite T√ºr√º</label><select id="activity-type" class="form-control" required><option value="">Se√ßin...</option><option value="training">Antrenman</option><option value="match">Ma√ß</option></select></div>
                </div>
                <!-- Ek veri giri≈ü alanlarƒ± -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="duration">S√ºre (dk)</label>
                        <input type="number" id="duration" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="distance">Toplam Mesafe (m)</label>
                        <input type="number" id="distance" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="hs16">16+ km/h Mesafe (m)</label>
                        <input type="number" id="hs16" class="form-control" min="0" step="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="hs18">18+ km/h Mesafe (m)</label>
                        <input type="number" id="hs18" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="hs20">20+ km/h Mesafe (m)</label>
                        <input type="number" id="hs20" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="sprint">24+ km/h Sprint Mesafe (m)</label>
                        <input type="number" id="sprint" class="form-control" min="0" step="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="acc">ƒ∞vmelenme/Decc Sayƒ±sƒ±</label>
                        <input type="number" id="acc" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="high_acc">Y√ºksek ƒ∞vmelenme Sayƒ±sƒ±</label>
                        <input type="number" id="high_acc" class="form-control" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="metabolic">Metabolik G√º√ß Mesafesi (m)</label>
                        <input type="number" id="metabolic" class="form-control" min="0" step="1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="notes">Notlar</label>
                    <textarea id="notes" class="form-control" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-success">üíæ Kaydet</button>
            </form>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2>üìà Performans Analizi</h2>
            <div id="analysis-alert"></div>
            <div class="form-row">
                <div class="form-group"><label for="analysis-players">Oyuncular (Ctrl+Click √ßoklu se√ßim)</label><select id="analysis-players" class="form-control" multiple size="5"></select></div>
                <div class="form-group"><label for="start-date">Ba≈ülangƒ±√ß Tarihi</label><input type="date" id="start-date" class="form-control"></div>
                <div class="form-group"><label for="end-date">Biti≈ü Tarihi</label><input type="date" id="end-date" class="form-control"></div>
            </div>
            <button onclick="runAnalysis()" class="btn">üîÑ Analiz Yap</button>
            <div id="analysis-results" style="display: none;">
                <div class="chart-container"><canvas id="analysis-chart"></canvas></div>
                <div class="table-container"><h3>üìã Detaylƒ± Sonu√ßlar</h3><table class="table"><thead><tr><th>Oyuncu</th><th>Ant. Ort.</th><th>Ma√ß Ort.</th><th>Mesafe %</th><th>HS16 %</th><th>HS20 %</th><th>Sprint %</th></tr></thead><tbody id="analysis-table"></tbody></table></div>
            </div>
        </div>

        <!-- Team Management Tab -->
        <div id="team-management" class="tab-content">
            <h2>üõ†Ô∏è Takƒ±m Y√∂netimi</h2>
            <div id="team-alert"></div>
            <form id="team-form">
                <div class="form-row">
                    <div class="form-group"><label for="team-name">Yeni Takƒ±m Adƒ±</label><input type="text" id="team-name" class="form-control" required></div>
                </div>
                <button type="submit" class="btn">‚ûï Takƒ±m Ekle</button>
            </form>
            <div class="table-container">
                <h3>Mevcut Takƒ±mlar</h3>
                <table class="table"><thead><tr><th>Takƒ±m Adƒ±</th><th>Kayƒ±t Tarihi</th></tr></thead><tbody id="teams-table"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        let currentTeamId = null;
        let teams = [];
        let players = [];
        let analysisChart = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('activity-date').value = today;
            document.getElementById('start-date').value = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            document.getElementById('end-date').value = today;
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/teams');
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                loadTeams();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        }

        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tabName === 'team-management') loadTeamsTable();
            
            // Tab deƒüi≈üikliklerinde uyarƒ±larƒ± g√∂ster
            const tabMessages = {
                'team-management': currentTeamId ? '' : '√ñnce bir takƒ±m olu≈üturun veya se√ßin.',
                'players': !currentTeamId ? '√ñnce bir takƒ±m se√ßmelisiniz.' : '',
                'data-entry': !currentTeamId ? '√ñnce bir takƒ±m se√ßmelisiniz.' : (players.length === 0 ? 'Bu takƒ±mda oyuncu yok. √ñnce oyuncu ekleyin.' : ''),
                'analysis': !currentTeamId ? '√ñnce bir takƒ±m se√ßmelisiniz.' : (players.length === 0 ? 'Bu takƒ±mda oyuncu yok. Analiz i√ßin oyuncu gerekli.' : '')
            };
            
            const message = tabMessages[tabName];
            if (message) {
                const alertIds = {
                    'team-management': 'team-alert',
                    'players': 'player-alert', 
                    'data-entry': 'data-entry-alert',
                    'analysis': 'analysis-alert'
                };
                setTimeout(() => showAlert(alertIds[tabName] || 'team-alert', 'error', message), 100);
            }
        }

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Teams y√ºklenemedi');
                }
                teams = await response.json();
                const teamSelect = document.getElementById('team-select');
                teamSelect.innerHTML = '';
                
                if (teams.length > 0) {
                    teamSelect.innerHTML = '<option value="">Takƒ±m se√ßin...</option>';
                    teams.forEach(team => {
                        const option = new Option(team.name, team.id);
                        teamSelect.add(option);
                    });
                    
                    // √ñnceki se√ßimi geri y√ºkle
                    const savedTeamId = localStorage.getItem('selectedTeamId');
                    if (savedTeamId && teams.find(t => t.id == savedTeamId)) {
                        teamSelect.value = savedTeamId;
                        currentTeamId = savedTeamId;
                    }
                } else {
                    teamSelect.innerHTML = '<option value="">√ñnce takƒ±m olu≈üturun</option>';
                    showTab('team-management');
                    showAlert('team-alert', 'success', 'Ho≈ügeldiniz! L√ºtfen √∂nce bir takƒ±m olu≈üturun.');
                }
                
                handleTeamChange();
            } catch (error) {
                console.error('Error loading teams:', error);
                showAlert('team-alert', 'error', 'Takƒ±mlar y√ºklenirken hata olu≈ütu.');
            }
        }

        function handleTeamChange() {
            const teamSelect = document.getElementById('team-select');
            currentTeamId = teamSelect.value;
            
            if (currentTeamId) {
                localStorage.setItem('selectedTeamId', currentTeamId);
                loadDashboardData();
                loadPlayers();
                
                // Se√ßili takƒ±m adƒ±nƒ± g√∂ster
                const selectedTeam = teams.find(t => t.id == currentTeamId);
                if (selectedTeam) {
                    document.getElementById('dashboard-title').textContent = `üèÜ ${selectedTeam.name} - Performans √ñzeti`;
                }
            } else {
                // Takƒ±m se√ßilmediƒüinde verileri temizle
                document.getElementById('dashboard-title').textContent = 'üèÜ Takƒ±m Performans √ñzeti';
                document.getElementById('total-players').textContent = '-';
                document.getElementById('total-activities').textContent = '-';
                document.getElementById('total-trainings').textContent = '-';
                document.getElementById('total-matches').textContent = '-';
                document.getElementById('recent-activities').innerHTML = '<tr><td colspan="5" class="loading">Takƒ±m se√ßiniz</td></tr>';
                
                players = [];
                updatePlayerDropdowns();
                loadPlayersTable();
            }
        }

        async function loadDashboardData() {
            if (!currentTeamId) return;
            try {
                const response = await fetch(`/api/dashboard-stats?team_id=${currentTeamId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Dashboard verileri y√ºklenemedi');
                }
                const data = await response.json();
                document.getElementById('total-players').textContent = data.players_count;
                document.getElementById('total-activities').textContent = data.activities_count;
                document.getElementById('total-trainings').textContent = data.training_count;
                document.getElementById('total-matches').textContent = data.match_count;
                
                const tbody = document.getElementById('recent-activities');
                tbody.innerHTML = '';
                if (data.recent_activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">Hen√ºz aktivite kaydƒ± yok.</td></tr>';
                } else {
                    data.recent_activities.forEach(act => {
                        tbody.innerHTML += `<tr><td>${act.date}</td><td>${act.player_name}</td><td>${act.activity_type === 'training' ? 'üèÉ Antrenman' : '‚öΩ Ma√ß'}</td><td>${act.total_distance_m || '-'}</td><td>${act.duration_minutes || '-'}</td></tr>`;
                    });
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('team-alert', 'error', 'Dashboard verileri y√ºklenirken hata olu≈ütu.');
            }
        }

        async function loadPlayers() {
            if (!currentTeamId) return;
            try {
                const response = await fetch(`/api/players?team_id=${currentTeamId}`);
                players = await response.json();
                loadPlayersTable();
                updatePlayerDropdowns();
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        function loadPlayersTable() {
            const tbody = document.getElementById('players-table');
            tbody.innerHTML = '';
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="loading">Bu takƒ±ma ait oyuncu yok.</td></tr>';
            } else {
                players.forEach(p => {
                    tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.position}</td><td>${new Date(p.created_at).toLocaleDateString('tr-TR')}</td></tr>`;
                });
            }
        }

        function updatePlayerDropdowns() {
            const playerSelect = document.getElementById('player-select');
            const analysisPlayers = document.getElementById('analysis-players');
            playerSelect.innerHTML = '<option value="">Oyuncu se√ßin...</option>';
            analysisPlayers.innerHTML = '';
            players.forEach(p => {
                playerSelect.add(new Option(p.name, p.id));
                analysisPlayers.add(new Option(p.name, p.id));
            });
        }

        document.getElementById('player-form').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('player-name').value;
            const position = document.getElementById('player-position').value;
            if (!currentTeamId) {
                showAlert('player-alert', 'error', '√ñnce bir takƒ±m se√ßmelisiniz.');
                return;
            }
            try {
                const response = await fetch('/api/players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, position, team_id: currentTeamId })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('player-alert', 'success', 'Oyuncu eklendi.');
                    e.target.reset();
                    loadPlayers();
                } else {
                    showAlert('player-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Error adding player:', error);
            }
        });

        document.getElementById('team-form').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('team-name').value;
            try {
                const response = await fetch('/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('team-alert', 'success', 'Takƒ±m eklendi.');
                    e.target.reset();
                    loadTeams();
                    loadTeamsTable();
                } else {
                    showAlert('team-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Error adding team:', error);
            }
        });

        function loadTeamsTable() {
            const tbody = document.getElementById('teams-table');
            tbody.innerHTML = '';
            if(teams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="loading">Takƒ±m yok.</td></tr>';
            } else {
                teams.forEach(t => {
                    tbody.innerHTML += `<tr><td>${t.name}</td><td>${new Date(t.created_at).toLocaleDateString('tr-TR')}</td></tr>`;
                });
            }
        }

        // Veri giri≈üi formunu i≈üle
        document.getElementById('activity-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!currentTeamId) {
                showAlert('data-entry-alert', 'error', '√ñnce bir takƒ±m se√ßmelisiniz.');
                return;
            }
            const playerId = document.getElementById('player-select').value;
            const date = document.getElementById('activity-date').value;
            const activityType = document.getElementById('activity-type').value;
            if (!playerId || !date || !activityType) {
                showAlert('data-entry-alert', 'error', 'L√ºtfen zorunlu alanlarƒ± doldurun.');
                return;
            }
            // Topla diƒüer alanlarƒ±; bo≈üsa null olsun
            const toInt = v => {
                const parsed = parseInt(v, 10);
                return isNaN(parsed) ? null : parsed;
            };
            const data = {
                player_id: parseInt(playerId, 10),
                date: date,
                activity_type: activityType,
                duration_minutes: toInt(document.getElementById('duration').value),
                total_distance_m: toInt(document.getElementById('distance').value),
                high_speed_16kmh_m: toInt(document.getElementById('hs16').value),
                high_speed_18kmh_m: toInt(document.getElementById('hs18').value),
                high_speed_20kmh_m: toInt(document.getElementById('hs20').value),
                sprint_24kmh_m: toInt(document.getElementById('sprint').value),
                acc_decc_count: toInt(document.getElementById('acc').value),
                high_acc_decc_count: toInt(document.getElementById('high_acc').value),
                high_metabolic_power_m: toInt(document.getElementById('metabolic').value),
                notes: document.getElementById('notes').value || null
            };
            try {
                const response = await fetch('/api/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const resData = await response.json();
                if (response.ok) {
                    showAlert('data-entry-alert', 'success', 'Aktivite kaydedildi.');
                    e.target.reset();
                    // Tarih alanƒ±nƒ± tekrar bug√ºne ayarla
                    document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
                    loadDashboardData();
                } else {
                    showAlert('data-entry-alert', 'error', resData.error || 'Hata olu≈ütu');
                }
            } catch (err) {
                console.error('Error adding activity:', err);
                showAlert('data-entry-alert', 'error', 'Sunucu hatasƒ±');
            }
        });

        // Analiz fonksiyonu
        async function runAnalysis() {
            if (!currentTeamId) {
                showAlert('analysis-alert', 'error', '√ñnce bir takƒ±m se√ßmelisiniz.');
                return;
            }
            
            const select = document.getElementById('analysis-players');
            const selectedIds = Array.from(select.selectedOptions).map(o => o.value);
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            if (selectedIds.length === 0) {
                showAlert('analysis-alert', 'error', 'L√ºtfen analiz i√ßin en az bir oyuncu se√ßiniz.');
                return;
            }
            if (!start || !end) {
                showAlert('analysis-alert', 'error', 'L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßiniz.');
                return;
            }
            if (new Date(start) > new Date(end)) {
                showAlert('analysis-alert', 'error', 'Ba≈ülangƒ±√ß tarihi biti≈ü tarihinden sonra olamaz.');
                return;
            }
            try {
                const response = await fetch('/api/analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_ids: selectedIds, start_date: start, end_date: end })
                });
                const result = await response.json();
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    showAlert('analysis-alert', 'error', result.error || 'Analiz hatasƒ±');
                    return;
                }
                
                if (result.players.length === 0) {
                    showAlert('analysis-alert', 'error', 'Se√ßilen tarih aralƒ±ƒüƒ±nda veri bulunamadƒ±.');
                    return;
                }
                // Tabloyu doldur
                const tbody = document.getElementById('analysis-table');
                tbody.innerHTML = '';
                const labels = [];
                const distanceData = [];
                const hs16Data = [];
                const hs20Data = [];
                const sprintData = [];
                result.players.forEach(item => {
                    labels.push(item.player_name);
                    const tDist = item.training.total_distance;
                    const mDist = item.match.total_distance;
                    const pctDist = item.ratios.distance_pct !== null ? item.ratios.distance_pct.toFixed(0) : '-';
                    const pct16 = item.ratios.hs16_pct !== null ? item.ratios.hs16_pct.toFixed(0) : '-';
                    const pct20 = item.ratios.hs20_pct !== null ? item.ratios.hs20_pct.toFixed(0) : '-';
                    const pctSprint = item.ratios.sprint_pct !== null ? item.ratios.sprint_pct.toFixed(0) : '-';
                    distanceData.push(item.ratios.distance_pct ?? 0);
                    hs16Data.push(item.ratios.hs16_pct ?? 0);
                    hs20Data.push(item.ratios.hs20_pct ?? 0);
                    sprintData.push(item.ratios.sprint_pct ?? 0);
                    const tDistDisplay = tDist !== null && tDist !== undefined ? Number(tDist).toFixed(0) : '-';
                    const mDistDisplay = mDist !== null && mDist !== undefined ? Number(mDist).toFixed(0) : '-';
                    tbody.innerHTML += `<tr><td>${item.player_name}</td><td>${tDistDisplay}</td><td>${mDistDisplay}</td><td>${pctDist}</td><td>${pct16}</td><td>${pct20}</td><td>${pctSprint}</td></tr>`;
                });
                document.getElementById('analysis-results').style.display = 'block';
                // Grafik
                const ctx = document.getElementById('analysis-chart').getContext('2d');
                if (analysisChart) analysisChart.destroy();
                analysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Mesafe %', data: distanceData, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                            { label: 'HS16 %', data: hs16Data, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                            { label: 'HS20 %', data: hs20Data, backgroundColor: 'rgba(255, 206, 86, 0.6)' },
                            { label: 'Sprint %', data: sprintData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '%' }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Analysis error:', err);
                showAlert('analysis-alert', 'error', 'Analiz sƒ±rasƒ±nda hata olu≈ütu.');
            }
        }

    </script>
</body>
</html>
