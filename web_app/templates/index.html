<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atletik Performans Takip Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header, .tab-content { 
            background: white; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .header h1 { 
            color: #212529; 
            margin-bottom: 20px; 
            text-align: center; 
            font-size: 1.75rem;
            font-weight: 600;
        }
        .team-selector-container { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .nav-tabs { 
            display: flex; 
            background-color: #e9ecef;
            border-radius: 8px; 
            padding: 5px; 
            margin-bottom: 20px; 
        }
        .nav-tab { 
            flex: 1; 
            padding: 10px 16px; 
            background: transparent; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            color: #495057;
            text-align: center;
            transition: all 0.3s ease; 
        }
        .nav-tab.active { 
            background-color: white; 
            color: #0d6efd; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 20px;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: white; 
            border: 1px solid #dee2e6;
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #0d6efd;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; }
        .form-control { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 6px; 
            font-size: 14px; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease; 
        }
        .form-control:focus { 
            outline: none; 
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .btn { 
            background-color: #0d6efd; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: background-color 0.2s ease; 
        }
        .btn:hover { background-color: #0b5ed7; }
        .btn-success { background-color: #198754; }
        .btn-success:hover { background-color: #157347; }
        .btn-danger {
            background-color: #dc3545;
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-danger:hover { background-color: #bb2d3b; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .table-container { 
            background: white; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px; 
        }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .chart-container { height: 400px; margin: 20px 0; }
        .alert { 
            padding: 12px 16px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            border: 1px solid transparent;
        }
        .alert-success { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
        .alert-error { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        @media (max-width: 768px) { .nav-tabs, .team-selector-container { flex-direction: column; } .form-row { grid-template-columns: 1fr; } }
        
        /* Player Detail Modal Styles */
        .detail-tabs { display: flex; gap: 0; }
        .detail-tab { padding: 12px 20px; border: none; background: #f8f9fa; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .detail-tab.active { background: #007bff; color: white; border-bottom-color: #0056b3; }
        .detail-tab:hover { background: #e9ecef; color: #333; }
        .detail-tab.active:hover { background: #0056b3; color: white; }
        
        .detail-tab-content { display: none; }
        .detail-tab-content.active { display: block; }
        
        .detail-section { margin-bottom: 30px; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; background: #fff; }
        .detail-section h4 { margin: 0 0 15px 0; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-item label { font-weight: 600; color: #495057; margin-bottom: 5px; }
        .detail-item .view-mode { padding: 8px; background: #f8f9fa; border-radius: 4px; min-height: 20px; }
        .detail-full-width { grid-column: 1/-1; }
        .detail-full-width label { font-weight: 600; color: #495057; margin-bottom: 5px; display: block; }
        .detail-full-width .view-mode { padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Atletik Performans Takip Sistemi</h1>
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                <span id="user-info" style="color: #495057; font-weight: 500;"></span>
                <button onclick="logout()" class="btn btn-danger">Çıkış</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('user-profile')">Profil</button>
            <button class="nav-tab" onclick="showTab('team-management')">Takım Yönetimi</button>
            <button class="nav-tab" onclick="showTab('players')">Antrenman Yönetimi</button>
            <button class="nav-tab" onclick="showTab('analysis')">Analiz</button>
        </div>

        <!-- User Profile Tab -->
        <div id="user-profile" class="tab-content active">
            <h2 style="text-align: center; margin-bottom: 40px;">Hoşgeldiniz! <span id="welcome-username">-</span></h2>
            <div id="profile-alert"></div>
            
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="user-teams">-</div><div>Toplam Takım</div></div>
                <div class="stat-card"><div class="stat-number" id="user-players">-</div><div>Toplam Oyuncu</div></div>
                <div class="stat-card"><div class="stat-number" id="user-activities">-</div><div>Toplam Aktivite</div></div>
                <div class="stat-card"><div class="stat-number" id="user-since">-</div><div>Hesap Yaşı (gün)</div></div>
            </div>

            <div class="form-row" style="margin-top: 40px;">
                <div style="flex: 1; margin-right: 20px;">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Profil Bilgileri</h3>
                            <button class="btn btn-sm" onclick="toggleProfileEdit()" id="profile-edit-toggle">Düzenle</button>
                        </div>
                        <div class="form-group">
                            <label>Kullanıcı Adı</label>
                            <div class="profile-info">
                                <span id="profile-username-display">-</span>
                                <input type="text" id="profile-username-edit" class="form-control" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <div class="profile-info">
                                <span id="profile-email-display">-</span>
                                <input type="email" id="profile-email-edit" class="form-control" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Hesap Oluşturma Tarihi</label>
                            <span id="profile-created-date">-</span>
                        </div>
                        <div id="profile-edit-buttons" style="display: none; margin-top: 20px;">
                            <button class="btn btn-success" onclick="saveProfile()">Kaydet</button>
                            <button class="btn" onclick="cancelProfileEdit()" style="margin-left: 10px;">İptal</button>
                        </div>
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Güvenlik</h3>
                            <button class="btn btn-sm" onclick="togglePasswordEdit()" id="password-edit-toggle">Şifre Değiştir</button>
                        </div>
                        <div class="form-group">
                            <label>Son Şifre Değiştirme</label>
                            <span>Henüz değiştirilmemiş</span>
                        </div>
                        <div id="password-edit-form" style="display: none;">
                            <div class="form-group">
                                <label for="current-password">Mevcut Şifre</label>
                                <input type="password" id="current-password" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">Yeni Şifre (en az 6 karakter)</label>
                                <input type="password" id="new-password" class="form-control" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Yeni Şifre Tekrar</label>
                                <input type="password" id="confirm-password" class="form-control" required minlength="6">
                            </div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-success" onclick="savePassword()">Şifre Değiştir</button>
                                <button class="btn" onclick="cancelPasswordEdit()" style="margin-left: 10px;">İptal</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Antrenman Yönetimi</h2>
                <div class="team-selector-container">
                    <label for="player-team-select" style="font-weight: 500;">Takım Seç:</label>
                    <select id="player-team-select" class="form-control" onchange="handlePlayerTeamChange()" style="min-width: 200px; margin-left: 10px;"></select>
                </div>
            </div>
            <div id="player-alert"></div>
            
            <!-- Add Player Button (shown only when team is selected) -->
            <div id="add-player-section" style="display: none; margin-bottom: 20px;">
                <button class="btn btn-success" onclick="openPlayerModal()" style="margin-right: 10px;">➕ Yeni Oyuncu Ekle</button>
                <span style="color: #666; font-size: 14px;">Seçili takıma yeni oyuncu ekleyebilirsiniz</span>
            </div>
            
            <div class="table-container">
                <h3>Mevcut Oyuncular</h3>
                <table class="table"><thead><tr><th>Oyuncu Adı</th><th>Pozisyon</th><th>Kayıt Tarihi</th><th>Aksiyonlar</th></tr></thead><tbody id="players-table"></tbody></table>
            </div>
        </div>


        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2>Performans Analizi</h2>
            <div id="analysis-alert"></div>
            <div class="form-row">
                <div class="form-group"><label for="analysis-players">Oyuncular (Ctrl+Click çoklu seçim)</label><select id="analysis-players" class="form-control" multiple size="5"></select></div>
                <div class="form-group"><label for="start-date">Başlangıç Tarihi</label><input type="date" id="start-date" class="form-control"></div>
                <div class="form-group"><label for="end-date">Bitiş Tarihi</label><input type="date" id="end-date" class="form-control"></div>
            </div>
            <button onclick="runAnalysis()" class="btn">Analiz Yap</button>
            <div id="analysis-results" style="display: none;">
                <div class="chart-container"><canvas id="analysis-chart"></canvas></div>
                <div class="table-container"><h3>Detaylı Sonuçlar</h3><table class="table"><thead><tr><th>Oyuncu</th><th>Ant. Ort.</th><th>Maç Ort.</th><th>Mesafe %</th><th>HS16 %</th><th>HS20 %</th><th>Sprint %</th></tr></thead><tbody id="analysis-table"></tbody></table></div>
            </div>
        </div>

        <!-- Team Management Tab -->
        <div id="team-management" class="tab-content">
            <h2>Takım & Oyuncu Yönetimi</h2>
            <div id="team-alert"></div>
            
            <!-- Step 1: Current Teams -->
            <div class="table-container">
                <h3>1️⃣ Mevcut Takımlarınız</h3>
                <table class="table"><thead><tr><th>Takım Adı</th><th>Lig</th><th>Sezon</th><th>Antrenör</th><th>Oyuncu Sayısı</th><th>Aksiyonlar</th></tr></thead><tbody id="teams-table"></tbody></table>
            </div>
            
            <!-- Step 2: Team Management -->
            <div class="table-container" style="margin-top: 30px;">
                <h3>2️⃣ Takım Yönetimi</h3>
                <form id="team-form">
                    <div class="form-row">
                        <div class="form-group"><label for="team-name">Takım Adı *</label><input type="text" id="team-name" class="form-control" required placeholder="örn: U17 Milli Takım"></div>
                        <div class="form-group"><label for="team-league">Lig</label><input type="text" id="team-league" class="form-control" placeholder="örn: Süper Lig"></div>
                        <div class="form-group"><label for="team-season">Sezon</label><input type="text" id="team-season" class="form-control" placeholder="örn: 2024-2025"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="team-coach">Antrenör Adı</label><input type="text" id="team-coach" class="form-control" placeholder="örn: Ahmet Yılmaz"></div>
                        <div class="form-group"><label for="team-description">Açıklama</label><textarea id="team-description" class="form-control" rows="2" placeholder="Takım hakkında notlar..."></textarea></div>
                    </div>
                    <button type="submit" class="btn">Takım Oluştur</button>
                </form>
            </div>
            
        </div>
        
        <!-- Player Detail Modal -->
        <div id="player-modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="player-modal-title">Yeni Oyuncu Ekle</h3>
                    <span class="close" onclick="closePlayerModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="player-detail-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player-first-name">Ad *</label>
                                <input type="text" id="player-first-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="player-last-name">Soyad *</label>
                                <input type="text" id="player-last-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="player-birth-date">Doğum Tarihi</label>
                                <input type="date" id="player-birth-date" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player-nationality">Uyruk</label>
                                <input type="text" id="player-nationality" class="form-control" placeholder="Türkiye">
                            </div>
                            <div class="form-group">
                                <label for="player-primary-position">Ana Pozisyon</label>
                                <select id="player-primary-position" class="form-control">
                                    <option value="">Seçiniz</option>
                                    <option value="GK">Kaleci (GK)</option>
                                    <option value="CB">Stoper (CB)</option>
                                    <option value="LB">Sol Bek (LB)</option>
                                    <option value="RB">Sağ Bek (RB)</option>
                                    <option value="CDM">Defansif Orta Saha (CDM)</option>
                                    <option value="CM">Orta Saha (CM)</option>
                                    <option value="CAM">Ofansif Orta Saha (CAM)</option>
                                    <option value="LM">Sol Orta Saha (LM)</option>
                                    <option value="RM">Sağ Orta Saha (RM)</option>
                                    <option value="LW">Sol Kanat (LW)</option>
                                    <option value="RW">Sağ Kanat (RW)</option>
                                    <option value="ST">Santrafor (ST)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="player-secondary-positions">Alt Pozisyonlar</label>
                                <input type="text" id="player-secondary-positions" class="form-control" placeholder="CM,CAM">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player-preferred-foot">Tercih Ettiği Ayak</label>
                                <select id="player-preferred-foot" class="form-control">
                                    <option value="">Seçiniz</option>
                                    <option value="Sağ">Sağ</option>
                                    <option value="Sol">Sol</option>
                                    <option value="Her ikisi">Her ikisi</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="player-jersey-number">Forma Numarası</label>
                                <input type="number" id="player-jersey-number" class="form-control" min="1" max="99">
                            </div>
                            <div class="form-group">
                                <label for="player-height">Boy (cm)</label>
                                <input type="number" id="player-height" class="form-control" min="140" max="220">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player-weight">Kilo (kg)</label>
                                <input type="number" id="player-weight" class="form-control" min="35" max="150" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="player-previous-club">Geldiği Takım</label>
                                <input type="text" id="player-previous-club" class="form-control" placeholder="Fenerbahçe U19">
                            </div>
                            <div class="form-group">
                                <label for="player-blood-type">Kan Grubu</label>
                                <select id="player-blood-type" class="form-control">
                                    <option value="">Seçiniz</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="player-phone">Telefon</label>
                                <input type="tel" id="player-phone" class="form-control" placeholder="0555-123-4567">
                            </div>
                            <div class="form-group">
                                <label for="player-email">Email</label>
                                <input type="email" id="player-email" class="form-control" placeholder="oyuncu@email.com">
                            </div>
                            <div class="form-group">
                                <label for="player-emergency-contact">Acil Durum Kişisi</label>
                                <input type="text" id="player-emergency-contact" class="form-control" placeholder="Anne: 0555-987-6543">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="player-notes">Notlar</label>
                            <textarea id="player-notes" class="form-control" rows="3" placeholder="Oyuncu hakkında notlar..."></textarea>
                        </div>
                        
                        <div id="player-modal-alert"></div>
                        <button type="submit" class="btn btn-success">Kaydet</button>
                        <button type="button" class="btn" onclick="closePlayerModal()" style="margin-left: 10px;">İptal</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Entry Modal -->
    <div id="data-entry-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-player-name">Veri Girişi</h3>
                <span class="close" onclick="closeDataEntryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="modal-activity-form">
                    <input type="hidden" id="modal-player-id">
                    <div class="form-row">
                        <div class="form-group"><label for="modal-activity-date">Tarih</label><input type="date" id="modal-activity-date" class="form-control" required></div>
                        <div class="form-group"><label for="modal-activity-type">Aktivite Türü</label><select id="modal-activity-type" class="form-control" required><option value="">Seçin...</option><option value="training">Antrenman</option><option value="match">Maç</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="modal-duration">Süre (dk)</label><input type="number" id="modal-duration" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-distance">Toplam Mesafe (m)</label><input type="number" id="modal-distance" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-hs16">16+ km/h Mesafe (m)</label><input type="number" id="modal-hs16" class="form-control" min="0" step="1"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="modal-hs18">18+ km/h Mesafe (m)</label><input type="number" id="modal-hs18" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-hs20">20+ km/h Mesafe (m)</label><input type="number" id="modal-hs20" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-sprint">24+ km/h Sprint Mesafe (m)</label><input type="number" id="modal-sprint" class="form-control" min="0" step="1"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="modal-acc">AccDecc Sayısı</label><input type="number" id="modal-acc" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-high_acc">Yüksek AccDecc Sayısı</label><input type="number" id="modal-high_acc" class="form-control" min="0" step="1"></div>
                        <div class="form-group"><label for="modal-metabolic">Metabolik Güç Mesafesi (m)</label><input type="number" id="modal-metabolic" class="form-control" min="0" step="1"></div>
                    </div>
                    <div class="form-group"><label for="modal-notes">Notlar</label><textarea id="modal-notes" class="form-control" rows="2"></textarea></div>
                    <div id="modal-alert"></div>
                    <button type="submit" class="btn btn-success">Kaydet</button>
                    <button type="button" class="btn" onclick="closeDataEntryModal()" style="margin-left: 10px;">İptal</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Player Detail Modal -->
    <div id="player-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="player-detail-title">Oyuncu Detayları</h3>
                <span class="close" onclick="closePlayerDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Player Summary Card -->
                <div class="player-summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="player-avatar" style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            👤
                        </div>
                        <div style="flex: 1;">
                            <h2 id="detail-player-name" style="margin: 0; color: white;">-</h2>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <span><strong>Pozisyon:</strong> <span id="detail-position">-</span></span>
                                <span><strong>Yaş:</strong> <span id="detail-age">-</span></span>
                                <span><strong>Forma:</strong> #<span id="detail-jersey">-</span></span>
                                <span><strong>Boy:</strong> <span id="detail-height">-</span>cm</span>
                                <span><strong>Kilo:</strong> <span id="detail-weight">-</span>kg</span>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn" onclick="togglePlayerEdit()" id="edit-toggle-btn" style="background: rgba(255,255,255,0.2); color: white; margin-bottom: 10px;">✏️ Düzenle</button>
                            <div style="font-size: 12px; opacity: 0.8;">Son güncelleme<br><span id="detail-updated">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="detail-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                    <button class="detail-tab active" onclick="showDetailTab('personal')" id="tab-personal">Kişisel Bilgiler</button>
                    <button class="detail-tab" onclick="showDetailTab('performance')" id="tab-performance">Performans Geçmişi</button>
                    <button class="detail-tab" onclick="showDetailTab('stats')" id="tab-stats">İstatistikler</button>
                    <button class="detail-tab" onclick="showDetailTab('data-entry')" id="tab-data-entry">Veri Girişi</button>
                </div>

                <!-- Tab Contents -->
                <div id="detail-content-personal" class="detail-tab-content active">
                    <div class="detail-section">
                        <h4>Temel Bilgiler</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Ad:</label>
                                <span id="view-first-name" class="view-mode">-</span>
                                <input type="text" id="edit-first-name" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Soyad:</label>
                                <span id="view-last-name" class="view-mode">-</span>
                                <input type="text" id="edit-last-name" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Doğum Tarihi:</label>
                                <span id="view-birth-date" class="view-mode">-</span>
                                <input type="date" id="edit-birth-date" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Uyruk:</label>
                                <span id="view-nationality" class="view-mode">-</span>
                                <input type="text" id="edit-nationality" class="edit-mode form-control" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Pozisyon & Oyun</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Ana Pozisyon:</label>
                                <span id="view-primary-position" class="view-mode">-</span>
                                <select id="edit-primary-position" class="edit-mode form-control" style="display: none;">
                                    <option value="GK">Kaleci (GK)</option>
                                    <option value="CB">Stoper (CB)</option>
                                    <option value="LB">Sol Bek (LB)</option>
                                    <option value="RB">Sağ Bek (RB)</option>
                                    <option value="CDM">Defansif Orta Saha (CDM)</option>
                                    <option value="CM">Orta Saha (CM)</option>
                                    <option value="CAM">Ofansif Orta Saha (CAM)</option>
                                    <option value="LM">Sol Orta Saha (LM)</option>
                                    <option value="RM">Sağ Orta Saha (RM)</option>
                                    <option value="LW">Sol Kanat (LW)</option>
                                    <option value="RW">Sağ Kanat (RW)</option>
                                    <option value="ST">Santrafor (ST)</option>
                                </select>
                            </div>
                            <div class="detail-item">
                                <label>Yan Pozisyonlar:</label>
                                <span id="view-secondary-positions" class="view-mode">-</span>
                                <input type="text" id="edit-secondary-positions" class="edit-mode form-control" style="display: none;" placeholder="örn: RW,CAM">
                            </div>
                            <div class="detail-item">
                                <label>Tercih Edilen Ayak:</label>
                                <span id="view-preferred-foot" class="view-mode">-</span>
                                <select id="edit-preferred-foot" class="edit-mode form-control" style="display: none;">
                                    <option value="Sağ">Sağ</option>
                                    <option value="Sol">Sol</option>
                                    <option value="Her ikisi">Her ikisi</option>
                                </select>
                            </div>
                            <div class="detail-item">
                                <label>Forma Numarası:</label>
                                <span id="view-jersey-number" class="view-mode">-</span>
                                <input type="number" id="edit-jersey-number" class="edit-mode form-control" style="display: none;" min="1" max="99">
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Fiziksel Özellikler & Sağlık</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Boy (cm):</label>
                                <span id="view-height-cm" class="view-mode">-</span>
                                <input type="number" id="edit-height-cm" class="edit-mode form-control" style="display: none;" min="150" max="220">
                            </div>
                            <div class="detail-item">
                                <label>Güncel Kilo (kg):</label>
                                <span id="view-weight-kg" class="view-mode">-</span>
                                <div class="edit-mode" style="display: none;">
                                    <button type="button" class="btn btn-sm" onclick="showWeightHistoryModal()" style="background: #28a745; color: white; margin-top: 5px;">
                                        📊 Kilo Geçmişi
                                    </button>
                                </div>
                            </div>
                            <div class="detail-item">
                                <label>Kan Grubu:</label>
                                <span id="view-blood-type" class="view-mode">-</span>
                                <select id="edit-blood-type" class="edit-mode form-control" style="display: none;">
                                    <option value="">Bilinmiyor</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div class="detail-item">
                                <label>Mevcut Sağlık Durumu:</label>
                                <span id="view-current-injury-status" class="view-mode">-</span>
                                <input type="text" id="edit-current-injury-status" class="edit-mode form-control" style="display: none;" placeholder="Sağlam, Sakatlık var, vb.">
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>İletişim</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Telefon:</label>
                                <span id="view-phone" class="view-mode">-</span>
                                <input type="tel" id="edit-phone" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span id="view-email" class="view-mode">-</span>
                                <input type="email" id="edit-email" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Acil Durum Kişisi:</label>
                                <span id="view-emergency-contact" class="view-mode">-</span>
                                <input type="text" id="edit-emergency-contact" class="edit-mode form-control" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Kulüp Geçmişi</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Önceki Kulüp:</label>
                                <span id="view-previous-club" class="view-mode">-</span>
                                <input type="text" id="edit-previous-club" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Sözleşme Başlangıç:</label>
                                <span id="view-contract-start" class="view-mode">-</span>
                                <input type="date" id="edit-contract-start" class="edit-mode form-control" style="display: none;">
                            </div>
                            <div class="detail-item">
                                <label>Sözleşme Bitiş:</label>
                                <span id="view-contract-end" class="view-mode">-</span>
                                <input type="date" id="edit-contract-end" class="edit-mode form-control" style="display: none;">
                            </div>
                        </div>
                        <div class="detail-full-width">
                            <label>Kulüp Geçmişi:</label>
                            <div id="view-club-history" class="view-mode" style="margin-top: 5px;">-</div>
                            <textarea id="edit-club-history" class="edit-mode form-control" style="display: none;" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Sakatlık Geçmişi & Notlar</h4>
                        <div class="detail-full-width">
                            <label>Sakatlık Durumu:</label>
                            <div id="view-injury-status" class="view-mode" style="margin-top: 5px;">Aktif sakatlık bulunmuyor</div>
                            <div class="edit-mode" style="display: none;">
                                <button type="button" class="btn btn-sm" onclick="showInjuryHistoryModal()" style="background: #dc3545; color: white; margin-top: 5px;">
                                    🏥 Sakatlık Geçmişi
                                </button>
                            </div>
                        </div>
                        <div class="detail-full-width">
                            <label>Notlar:</label>
                            <div id="view-notes" class="view-mode" style="margin-top: 5px;">-</div>
                            <textarea id="edit-notes" class="edit-mode form-control" style="display: none;" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Edit Mode Buttons -->
                    <div class="edit-mode" style="display: none; margin-top: 30px; text-align: center;">
                        <button class="btn btn-success" onclick="savePlayerDetails()" style="margin-right: 10px;">💾 Kaydet</button>
                        <button class="btn" onclick="cancelPlayerEdit()">❌ İptal</button>
                    </div>
                </div>

                <div id="detail-content-performance" class="detail-tab-content" style="display: none;">
                    <div class="detail-section">
                        <h4>Son Aktiviteler</h4>
                        <div id="player-activities-list">
                            <div class="loading">Aktiviteler yükleniyor...</div>
                        </div>
                    </div>
                </div>

                <div id="detail-content-stats" class="detail-tab-content" style="display: none;">
                    <div class="detail-section">
                        <h4>Performans İstatistikleri</h4>
                        <div id="player-stats-summary">
                            <div class="loading">İstatistikler yükleniyor...</div>
                        </div>
                    </div>
                </div>
                <div id="detail-content-data-entry" class="detail-tab-content" style="display: none;">
                    <div class="detail-section">
                        <h4>Antrenman/Maç Verisi Ekle</h4>
                        <form id="player-detail-activity-form">
                            <div id="player-detail-modal-alert" class="alert" style="display: none;"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="player-detail-activity-date">Tarih</label>
                                    <input type="date" id="player-detail-activity-date" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-activity-time">Saat</label>
                                    <input type="time" id="player-detail-activity-time" class="form-control" placeholder="Opsiyonel">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-activity-type">Aktivite Türü</label>
                                    <select id="player-detail-activity-type" class="form-control" required>
                                        <option value="">Seçin...</option>
                                        <option value="training">Antrenman</option>
                                        <option value="match">Maç</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="player-detail-duration">Süre (dk)</label>
                                    <input type="number" id="player-detail-duration" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-distance">Toplam Mesafe (m)</label>
                                    <input type="number" id="player-detail-distance" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-hs16">16+ km/h Mesafe (m)</label>
                                    <input type="number" id="player-detail-hs16" class="form-control" min="0" step="1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="player-detail-hs18">18+ km/h Mesafe (m)</label>
                                    <input type="number" id="player-detail-hs18" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-hs20">20+ km/h Mesafe (m)</label>
                                    <input type="number" id="player-detail-hs20" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-hs24">24+ km/h Mesafe (m)</label>
                                    <input type="number" id="player-detail-hs24" class="form-control" min="0" step="1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="player-detail-sprint-count">Sprint Sayısı</label>
                                    <input type="number" id="player-detail-sprint-count" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-acc-count">İvmelenme Sayısı</label>
                                    <input type="number" id="player-detail-acc-count" class="form-control" min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-dec-count">Yavaşlama Sayısı</label>
                                    <input type="number" id="player-detail-dec-count" class="form-control" min="0" step="1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="player-detail-metabolic-power">Metabolik Güç</label>
                                    <input type="number" id="player-detail-metabolic-power" class="form-control" min="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="player-detail-notes">Notlar</label>
                                    <textarea id="player-detail-notes" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">Aktivite Kaydet</button>
                                <button type="button" class="btn" onclick="resetPlayerDetailForm()" style="margin-left: 10px;">Formu Temizle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Weight History Modal -->
    <div id="weight-history-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="weight-history-title">Kilo Geçmişi</h3>
                <span class="close" onclick="closeWeightHistoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Add New Weight Form -->
                <div class="detail-section">
                    <h4>Yeni Kilo Ölçümü Ekle</h4>
                    <form id="weight-form">
                        <div id="weight-modal-alert" class="alert" style="display: none;"></div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight-date">Ölçüm Tarihi</label>
                                <input type="date" id="weight-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="weight-value">Kilo (kg)</label>
                                <input type="number" id="weight-value" class="form-control" step="0.1" min="40" max="150" required>
                            </div>
                            <div class="form-group">
                                <label for="weight-notes">Notlar</label>
                                <input type="text" id="weight-notes" class="form-control" placeholder="Opsiyonel notlar">
                            </div>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button type="submit" class="btn btn-success">Ölçüm Kaydet</button>
                        </div>
                    </form>
                </div>
                
                <!-- Weight History Table -->
                <div class="detail-section">
                    <h4>Kilo Geçmişi</h4>
                    <div id="weight-history-table">
                        <div class="loading">Kilo geçmişi yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Injury History Modal -->
    <div id="injury-history-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="injury-history-title">Sakatlık Geçmişi</h3>
                <span class="close" onclick="closeInjuryHistoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Add New Injury Form -->
                <div class="detail-section">
                    <h4>Yeni Sakatlık Kaydı Ekle</h4>
                    <form id="injury-form">
                        <div id="injury-modal-alert" class="alert" style="display: none;"></div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="injury-date">Sakatlık Tarihi</label>
                                <input type="date" id="injury-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="injury-type">Sakatlık Türü</label>
                                <select id="injury-type" class="form-control" required>
                                    <option value="">Seçiniz...</option>
                                    <option value="Kas">Kas Sakatlığı</option>
                                    <option value="Bağ">Bağ Sakatlığı</option>
                                    <option value="Eklem">Eklem Sakatlığı</option>
                                    <option value="Kırık">Kırık</option>
                                    <option value="Çıkık">Çıkık</option>
                                    <option value="Burkulma">Burkulma</option>
                                    <option value="Diğer">Diğer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="injury-status">Durum</label>
                                <select id="injury-status" class="form-control" required>
                                    <option value="active">Aktif</option>
                                    <option value="recovered">İyileşmiş</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="injury-recovery-date">İyileşme Tarihi</label>
                                <input type="date" id="injury-recovery-date" class="form-control">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="injury-description">Açıklama</label>
                                <textarea id="injury-description" class="form-control" rows="3" placeholder="Sakatlığın detayları..."></textarea>
                            </div>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button type="submit" class="btn btn-success">Sakatlık Kaydet</button>
                        </div>
                    </form>
                </div>
                
                <!-- Injury History Table -->
                <div class="detail-section">
                    <h4>Sakatlık Geçmişi</h4>
                    <div id="injury-history-table">
                        <div class="loading">Sakatlık geçmişi yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Edit Modal -->
    <div id="activity-edit-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="activity-edit-title">Aktivite Düzenle</h3>
                <span class="close" onclick="closeActivityEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="activity-edit-form">
                    <input type="hidden" id="edit-activity-id">
                    <div id="activity-edit-modal-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-activity-date">Tarih</label>
                            <input type="date" id="edit-activity-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-activity-time">Saat</label>
                            <input type="time" id="edit-activity-time" class="form-control" placeholder="Opsiyonel">
                        </div>
                        <div class="form-group">
                            <label for="edit-activity-type">Aktivite Türü</label>
                            <select id="edit-activity-type" class="form-control" required>
                                <option value="training">Antrenman</option>
                                <option value="match">Maç</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-duration">Süre (dk)</label>
                            <input type="number" id="edit-duration" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-distance">Toplam Mesafe (m)</label>
                            <input type="number" id="edit-distance" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-hs16">16+ km/h Mesafe (m)</label>
                            <input type="number" id="edit-hs16" class="form-control" min="0" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-hs18">18+ km/h Mesafe (m)</label>
                            <input type="number" id="edit-hs18" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-hs20">20+ km/h Mesafe (m)</label>
                            <input type="number" id="edit-hs20" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-hs24">24+ km/h Mesafe (m)</label>
                            <input type="number" id="edit-hs24" class="form-control" min="0" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-sprint-count">Sprint Sayısı</label>
                            <input type="number" id="edit-sprint-count" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-acc-count">İvmelenme Sayısı</label>
                            <input type="number" id="edit-acc-count" class="form-control" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-dec-count">Yavaşlama Sayısı</label>
                            <input type="number" id="edit-dec-count" class="form-control" min="0" step="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-metabolic-power">Metabolik Güç</label>
                            <input type="number" id="edit-metabolic-power" class="form-control" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="edit-activity-notes">Notlar</label>
                            <textarea id="edit-activity-notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">Aktivite Güncelle</button>
                        <button type="button" class="btn" onclick="closeActivityEditModal()" style="margin-left: 10px;">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentTeamId = null;
        let teams = [];
        let players = [];
        let analysisChart = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUserProfile();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            document.getElementById('end-date').value = today;
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/teams');
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                loadTeams();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
            }
        }

        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tabName === 'team-management') {
                loadTeamsTable();
            }
            
            const tabMessages = {
                'team-management': '',
                'players': !currentTeamId ? 'Profil sekmesinden bir takım seçmelisiniz.' : '',
                'analysis': !currentTeamId ? 'Profil sekmesinden bir takım seçmelisiniz.' : (players.length === 0 ? 'Bu takımda oyuncu yok. Analiz için oyuncu gerekli.' : '')
            };
            
            const message = tabMessages[tabName];
            if (message) {
                const alertIds = {
                    'team-management': 'team-alert',
                    'players': 'player-alert', 
                    'analysis': 'analysis-alert'
                };
                setTimeout(() => showAlert(alertIds[tabName] || 'team-alert', 'error', message), 100);
            }
            
            if (tabName === 'user-profile') {
                loadUserProfile();
            }
        }

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Teams yüklenemedi');
                }
                teams = await response.json();
                const teamSelect = document.getElementById('player-team-select');
                if (teamSelect) {
                    teamSelect.innerHTML = '';
                    
                    if (teams.length > 0) {
                        teamSelect.innerHTML = '<option value="">Takım seçin...</option>';
                        teams.forEach(team => {
                            const option = new Option(team.name, team.id);
                            teamSelect.add(option);
                        });
                        
                        const savedTeamId = localStorage.getItem('selectedTeamId');
                        if (savedTeamId && teams.find(t => t.id == savedTeamId)) {
                            teamSelect.value = savedTeamId;
                            currentTeamId = savedTeamId;
                        }
                    } else {
                        teamSelect.innerHTML = '<option value="">Önce takım oluşturun</option>';
                    }
                    
                    handlePlayerTeamChange();
                }
            } catch (error) {
                console.error('Error loading teams:', error);
                showAlert('team-alert', 'error', 'Takımlar yüklenirken hata oluştu.');
            }
        }

        function handlePlayerTeamChange() {
            const teamSelect = document.getElementById('player-team-select');
            currentTeamId = teamSelect.value;
            
            if (currentTeamId) {
                localStorage.setItem('selectedTeamId', currentTeamId);
                document.getElementById('add-player-section').style.display = 'block';
                loadPlayers();
            } else {
                document.getElementById('add-player-section').style.display = 'none';
                players = [];
                updatePlayerDropdowns();
                loadPlayersTable();
            }
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user/profile');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Profil verileri yüklenemedi');
                }
                const data = await response.json();
                
                // Update profile display
                document.getElementById('welcome-username').textContent = data.user.username;
                document.getElementById('profile-username-display').textContent = data.user.username;
                document.getElementById('profile-email-display').textContent = data.user.email;
                document.getElementById('profile-created-date').textContent = new Date(data.user.created_at).toLocaleDateString('tr-TR');
                document.getElementById('user-info').textContent = `Hoşgeldin, ${data.user.username}`;
                
                // Update stats
                document.getElementById('user-teams').textContent = data.stats.team_count;
                document.getElementById('user-players').textContent = data.stats.player_count;
                document.getElementById('user-activities').textContent = data.stats.activity_count;
                
                // Calculate account age
                const createdDate = new Date(data.user.created_at);
                const daysSince = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
                document.getElementById('user-since').textContent = daysSince;
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('profile-alert', 'error', 'Profil verileri yüklenirken hata oluştu.');
            }
        }

        async function loadPlayers() {
            if (!currentTeamId) return;
            try {
                const response = await fetch(`/api/players?team_id=${currentTeamId}`);
                players = await response.json();
                loadPlayersTable();
                updatePlayerDropdowns();
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        function loadPlayersTable() {
            const tbody = document.getElementById('players-table');
            tbody.innerHTML = '';
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">Bu takıma ait oyuncu yok.</td></tr>';
            } else {
                players.forEach(p => {
                    // Handle both new schema (first_name/last_name) and old schema (name)
                    const fullName = p.name || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'İsimsiz Oyuncu';
                    const position = p.primary_position || p.position || '-';
                    
                    tbody.innerHTML += `<tr><td>${fullName}</td><td>${position}</td><td>${new Date(p.created_at).toLocaleDateString('tr-TR')}</td><td><button class="btn btn-sm" onclick="openPlayerDetailModal(${p.id})" style="margin-right: 5px;">Detay</button><button class="btn btn-sm btn-danger" onclick="deletePlayer(${p.id}, '${fullName}')">Sil</button></td></tr>`;
                });
            }
        }

        function updatePlayerDropdowns() {
            const analysisPlayers = document.getElementById('analysis-players');
            analysisPlayers.innerHTML = '';
            players.forEach(p => {
                const fullName = p.name || `${p.first_name || ''} ${p.last_name || ''}`.trim() || 'İsimsiz Oyuncu';
                analysisPlayers.add(new Option(fullName, p.id));
            });
        }


        document.getElementById('team-form').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('team-name').value;
            const league = document.getElementById('team-league').value;
            const season = document.getElementById('team-season').value;
            const coach_name = document.getElementById('team-coach').value;
            const description = document.getElementById('team-description').value;
            
            try {
                const response = await fetch('/api/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, league, season, coach_name, description })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('team-alert', 'success', 'Takım eklendi.');
                    e.target.reset();
                    await loadTeams(); // Wait for teams to load first
                    loadTeamsTable();
                } else {
                    showAlert('team-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Error adding team:', error);
            }
        });

        async function loadTeamsTable() {
            const tbody = document.getElementById('teams-table');
            tbody.innerHTML = '';
            if(teams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Takım yok.</td></tr>';
                return;
            } 
            
            // Build all rows first, then insert at once
            let rowsHTML = '';
            for (const t of teams) {
                // Get player count for each team
                let playerCount = 0;
                try {
                    const response = await fetch(`/api/players?team_id=${t.id}`);
                    if (response.ok) {
                        const players = await response.json();
                        playerCount = players.length;
                    }
                } catch (error) {
                    console.error('Error loading player count:', error);
                }
                
                const league = t.league || '-';
                const season = t.season || '-';
                const coach = t.coach_name || '-';
                
                rowsHTML += `<tr>
                    <td><span id="team-name-${t.id}">${t.name}</span><input type="text" id="team-edit-${t.id}" value="${t.name}" class="form-control" style="display:none;"></td>
                    <td>${league}</td>
                    <td>${season}</td>
                    <td>${coach}</td>
                    <td>${playerCount} oyuncu</td>
                    <td>
                        <button class="btn btn-sm" onclick="editTeam(${t.id})" id="team-edit-btn-${t.id}" style="margin-right: 5px;">Düzenle</button>
                        <button class="btn btn-sm btn-success" onclick="saveTeam(${t.id})" id="team-save-btn-${t.id}" style="display:none; margin-right: 5px;">Kaydet</button>
                        <button class="btn btn-sm" onclick="cancelEditTeam(${t.id})" id="team-cancel-btn-${t.id}" style="display:none; margin-right: 5px;">İptal</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTeam(${t.id}, '${t.name}')">Sil</button>
                    </td>
                </tr>`;
            }
            tbody.innerHTML = rowsHTML;
        }


        async function runAnalysis() {
            if (!currentTeamId) {
                showAlert('analysis-alert', 'error', 'Önce bir takım seçmelisiniz.');
                return;
            }
            
            const select = document.getElementById('analysis-players');
            const selectedIds = Array.from(select.selectedOptions).map(o => o.value);
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            if (selectedIds.length === 0) {
                showAlert('analysis-alert', 'error', 'Lütfen analiz için en az bir oyuncu seçiniz.');
                return;
            }
            if (!start || !end) {
                showAlert('analysis-alert', 'error', 'Lütfen başlangıç ve bitiş tarihlerini seçiniz.');
                return;
            }
            if (new Date(start) > new Date(end)) {
                showAlert('analysis-alert', 'error', 'Başlangıç tarihi bitiş tarihinden sonra olamaz.');
                return;
            }
            try {
                const response = await fetch('/api/analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_ids: selectedIds, start_date: start, end_date: end })
                });
                const result = await response.json();
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/';
                        return;
                    }
                    showAlert('analysis-alert', 'error', result.error || 'Analiz hatası');
                    return;
                }
                
                if (result.players.length === 0) {
                    showAlert('analysis-alert', 'error', 'Seçilen tarih aralığında veri bulunamadı.');
                    return;
                }
                const tbody = document.getElementById('analysis-table');
                tbody.innerHTML = '';
                const labels = [];
                const distanceData = [];
                const hs16Data = [];
                const hs20Data = [];
                const sprintData = [];
                result.players.forEach(item => {
                    labels.push(item.player_name);
                    const tDist = item.training.total_distance;
                    const mDist = item.match.total_distance;
                    const pctDist = item.ratios.distance_pct !== null ? item.ratios.distance_pct.toFixed(0) : '-';
                    const pct16 = item.ratios.hs16_pct !== null ? item.ratios.hs16_pct.toFixed(0) : '-';
                    const pct20 = item.ratios.hs20_pct !== null ? item.ratios.hs20_pct.toFixed(0) : '-';
                    const pctSprint = item.ratios.sprint_pct !== null ? item.ratios.sprint_pct.toFixed(0) : '-';
                    distanceData.push(item.ratios.distance_pct ?? 0);
                    hs16Data.push(item.ratios.hs16_pct ?? 0);
                    hs20Data.push(item.ratios.hs20_pct ?? 0);
                    sprintData.push(item.ratios.sprint_pct ?? 0);
                    const tDistDisplay = tDist !== null && tDist !== undefined ? Number(tDist).toFixed(0) : '-';
                    const mDistDisplay = mDist !== null && mDist !== undefined ? Number(mDist).toFixed(0) : '-';
                    tbody.innerHTML += `<tr><td>${item.player_name}</td><td>${tDistDisplay}</td><td>${mDistDisplay}</td><td>${pctDist}</td><td>${pct16}</td><td>${pct20}</td><td>${pctSprint}</td></tr>`;
                });
                document.getElementById('analysis-results').style.display = 'block';
                
                const ctx = document.getElementById('analysis-chart').getContext('2d');
                if (analysisChart) analysisChart.destroy();
                analysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Mesafe %', data: distanceData, backgroundColor: '#0d6efd' },
                            { label: 'HS16 %', data: hs16Data, backgroundColor: '#6c757d' },
                            { label: 'HS20 %', data: hs20Data, backgroundColor: '#198754' },
                            { label: 'Sprint %', data: sprintData, backgroundColor: '#dc3545' }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '%' }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Analysis error:', err);
                showAlert('analysis-alert', 'error', 'Analiz sırasında hata oluştu.');
            }
        }

        function openDataEntryModal(playerId, playerName) {
            document.getElementById('modal-player-id').value = playerId;
            document.getElementById('modal-player-name').textContent = `${playerName} - Veri Girişi`;
            document.getElementById('modal-activity-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('data-entry-modal').style.display = 'block';
            document.getElementById('modal-alert').innerHTML = '';
            document.getElementById('modal-activity-form').reset();
            document.getElementById('modal-activity-date').value = new Date().toISOString().split('T')[0];
        }

        function closeDataEntryModal() {
            document.getElementById('data-entry-modal').style.display = 'none';
        }

        document.getElementById('modal-activity-form').addEventListener('submit', async e => {
            e.preventDefault();
            const playerId = document.getElementById('modal-player-id').value;
            const date = document.getElementById('modal-activity-date').value;
            const activityType = document.getElementById('modal-activity-type').value;
            
            if (!playerId || !date || !activityType) {
                showModalAlert('error', 'Lütfen zorunlu alanları doldurun.');
                return;
            }
            
            const toInt = v => {
                const parsed = parseInt(v, 10);
                return isNaN(parsed) ? null : parsed;
            };
            
            const data = {
                player_id: parseInt(playerId, 10),
                date: date,
                activity_type: activityType,
                duration_minutes: toInt(document.getElementById('modal-duration').value),
                total_distance_m: toInt(document.getElementById('modal-distance').value),
                high_speed_16kmh_m: toInt(document.getElementById('modal-hs16').value),
                high_speed_18kmh_m: toInt(document.getElementById('modal-hs18').value),
                high_speed_20kmh_m: toInt(document.getElementById('modal-hs20').value),
                sprint_24kmh_m: toInt(document.getElementById('modal-sprint').value),
                acc_decc_count: toInt(document.getElementById('modal-acc').value),
                high_acc_decc_count: toInt(document.getElementById('modal-high_acc').value),
                high_metabolic_power_m: toInt(document.getElementById('modal-metabolic').value),
                notes: document.getElementById('modal-notes').value || null
            };
            
            try {
                const response = await fetch('/api/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const resData = await response.json();
                if (response.ok) {
                    showModalAlert('success', 'Aktivite kaydedildi.');
                    setTimeout(() => {
                        closeDataEntryModal();
                        loadUserProfile();
                    }, 1500);
                } else {
                    showModalAlert('error', resData.error || 'Hata oluştu');
                }
            } catch (err) {
                console.error('Error adding activity:', err);
                showModalAlert('error', 'Sunucu hatası');
            }
        });

        function showModalAlert(type, message) {
            const container = document.getElementById('modal-alert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                if (type !== 'success') container.innerHTML = '';
            }, 5000);
        }

        // Modal dışına tıklayınca kapat
        window.onclick = function(event) {
            const modal = document.getElementById('data-entry-modal');
            if (event.target === modal) {
                closeDataEntryModal();
            }
        }
        
        // Player Detail Modal Data Entry Functions
        function resetPlayerDetailForm() {
            document.getElementById('player-detail-activity-form').reset();
            document.getElementById('player-detail-activity-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('player-detail-modal-alert').style.display = 'none';
        }
        
        function showPlayerDetailAlert(type, message) {
            const container = document.getElementById('player-detail-modal-alert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            container.style.display = 'block';
            setTimeout(() => {
                if (type !== 'success') container.style.display = 'none';
            }, 5000);
        }
        
        // Player Detail Modal Form Handler
        document.getElementById('player-detail-activity-form').addEventListener('submit', async e => {
            e.preventDefault();
            
            if (!currentPlayerData) {
                showPlayerDetailAlert('error', 'Oyuncu bilgisi bulunamadı.');
                return;
            }
            
            const date = document.getElementById('player-detail-activity-date').value;
            const activityType = document.getElementById('player-detail-activity-type').value;
            
            if (!date || !activityType) {
                showPlayerDetailAlert('error', 'Lütfen tarih ve aktivite türünü seçin.');
                return;
            }
            
            const toInt = v => {
                const parsed = parseInt(v, 10);
                return isNaN(parsed) ? null : parsed;
            };
            
            const data = {
                player_id: currentPlayerData.id,
                date: date,
                activity_time: document.getElementById('player-detail-activity-time').value || null,
                activity_type: activityType,
                duration_minutes: toInt(document.getElementById('player-detail-duration').value),
                total_distance_m: toInt(document.getElementById('player-detail-distance').value),
                high_speed_16kmh_m: toInt(document.getElementById('player-detail-hs16').value),
                high_speed_18kmh_m: toInt(document.getElementById('player-detail-hs18').value),
                high_speed_20kmh_m: toInt(document.getElementById('player-detail-hs20').value),
                high_speed_24kmh_m: toInt(document.getElementById('player-detail-hs24').value),
                sprint_count: toInt(document.getElementById('player-detail-sprint-count').value),
                acc_count: toInt(document.getElementById('player-detail-acc-count').value),
                dec_count: toInt(document.getElementById('player-detail-dec-count').value),
                metabolic_power: parseFloat(document.getElementById('player-detail-metabolic-power').value) || null,
                notes: document.getElementById('player-detail-notes').value || null
            };
            
            try {
                const response = await fetch('/api/activities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const resData = await response.json();
                if (response.ok) {
                    showPlayerDetailAlert('success', 'Aktivite başarıyla kaydedildi!');
                    resetPlayerDetailForm();
                    // Refresh performance and stats tabs if they are visible
                    if (document.getElementById('tab-performance').classList.contains('active')) {
                        loadPlayerActivities(currentPlayerData.id);
                    }
                    if (document.getElementById('tab-stats').classList.contains('active')) {
                        loadPlayerStats(currentPlayerData.id);
                    }
                    setTimeout(() => {
                        document.getElementById('player-detail-modal-alert').style.display = 'none';
                    }, 3000);
                } else {
                    showPlayerDetailAlert('error', resData.error || 'Aktivite kaydedilirken hata oluştu');
                }
            } catch (err) {
                console.error('Error adding activity:', err);
                showPlayerDetailAlert('error', 'Sunucu hatası oluştu');
            }
        });

        // Team Edit/Delete Functions
        function editTeam(teamId) {
            document.getElementById(`team-name-${teamId}`).style.display = 'none';
            document.getElementById(`team-edit-${teamId}`).style.display = 'block';
            document.getElementById(`team-edit-btn-${teamId}`).style.display = 'none';
            document.getElementById(`team-save-btn-${teamId}`).style.display = 'inline-block';
            document.getElementById(`team-cancel-btn-${teamId}`).style.display = 'inline-block';
        }

        function cancelEditTeam(teamId) {
            document.getElementById(`team-name-${teamId}`).style.display = 'block';
            document.getElementById(`team-edit-${teamId}`).style.display = 'none';
            document.getElementById(`team-edit-btn-${teamId}`).style.display = 'inline-block';
            document.getElementById(`team-save-btn-${teamId}`).style.display = 'none';
            document.getElementById(`team-cancel-btn-${teamId}`).style.display = 'none';
            // Reset input value
            const originalName = document.getElementById(`team-name-${teamId}`).textContent;
            document.getElementById(`team-edit-${teamId}`).value = originalName;
        }

        async function saveTeam(teamId) {
            const newName = document.getElementById(`team-edit-${teamId}`).value.trim();
            if (!newName) {
                showAlert('team-alert', 'error', 'Takım adı boş olamaz');
                return;
            }
            
            try {
                const response = await fetch(`/api/teams/${teamId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('team-alert', 'success', data.message);
                    document.getElementById(`team-name-${teamId}`).textContent = newName;
                    cancelEditTeam(teamId);
                    loadTeams(); // Refresh team list
                } else {
                    showAlert('team-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Team update error:', error);
                showAlert('team-alert', 'error', 'Güncelleme hatası');
            }
        }

        async function deleteTeam(teamId, teamName) {
            try {
                // Get delete stats first
                const statsResponse = await fetch(`/api/teams/${teamId}/stats`);
                const stats = await statsResponse.json();
                
                if (!statsResponse.ok) {
                    showAlert('team-alert', 'error', stats.error);
                    return;
                }
                
                const message = `"${teamName}" takımını silmek istediğinizden emin misiniz?\\n\\n${stats.player_count} oyuncu ve ${stats.activity_count} aktivite verisi kalıcı olarak silinecek.`;
                
                if (confirm(message)) {
                    const response = await fetch(`/api/teams/${teamId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        showAlert('team-alert', 'success', data.message);
                        loadTeams();
                        loadTeamsTable();
                            // Clear current team if deleted
                        if (currentTeamId == teamId) {
                            currentTeamId = null;
                            localStorage.removeItem('selectedTeamId');
                            handlePlayerTeamChange();
                        }
                    } else {
                        showAlert('team-alert', 'error', data.error);
                    }
                }
            } catch (error) {
                console.error('Team delete error:', error);
                showAlert('team-alert', 'error', 'Silme hatası');
            }
        }

        // Player Edit/Delete Functions


        async function deletePlayer(playerId, playerName) {
            try {
                // Get delete stats first
                const statsResponse = await fetch(`/api/players/${playerId}/stats`);
                const stats = await statsResponse.json();
                
                if (!statsResponse.ok) {
                    showAlert('player-alert', 'error', stats.error);
                    return;
                }
                
                const message = `"${playerName}" oyuncusunu silmek istediğinizden emin misiniz?\\n\\n${stats.activity_count} aktivite verisi kalıcı olarak silinecek.`;
                
                if (confirm(message)) {
                    const response = await fetch(`/api/players/${playerId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        showAlert('player-alert', 'success', data.message);
                        loadPlayers();
                        loadUserProfile();
                    } else {
                        showAlert('player-alert', 'error', data.error);
                    }
                }
            } catch (error) {
                console.error('Player delete error:', error);
                showAlert('player-alert', 'error', 'Silme hatası');
            }
        }




        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function viewPlayerDetails(player) {
            alert(`${player.first_name} ${player.last_name} detay sayfası henüz hazır değil.`);
        }

        // Player Modal Functions
        let editingPlayerId = null;

        function openPlayerModal(playerId = null) {
            editingPlayerId = playerId;
            const modal = document.getElementById('player-modal');
            const form = document.getElementById('player-detail-form');
            
            if (playerId) {
                document.getElementById('player-modal-title').textContent = 'Oyuncu Düzenle';
                // Load player data for editing
                loadPlayerForEdit(playerId);
            } else {
                document.getElementById('player-modal-title').textContent = 'Yeni Oyuncu Ekle';
                form.reset();
            }
            
            modal.style.display = 'block';
            document.getElementById('player-modal-alert').innerHTML = '';
        }

        function closePlayerModal() {
            document.getElementById('player-modal').style.display = 'none';
            editingPlayerId = null;
        }

        async function loadPlayerForEdit(playerId) {
            try {
                const response = await fetch(`/api/players?team_id=${selectedTeamForManagement}`);
                const players = await response.json();
                const player = players.find(p => p.id === playerId);
                
                if (player) {
                    document.getElementById('player-first-name').value = player.first_name || '';
                    document.getElementById('player-last-name').value = player.last_name || '';
                    document.getElementById('player-birth-date').value = player.birth_date || '';
                    document.getElementById('player-nationality').value = player.nationality || '';
                    document.getElementById('player-primary-position').value = player.primary_position || '';
                    document.getElementById('player-secondary-positions').value = player.secondary_positions || '';
                    document.getElementById('player-preferred-foot').value = player.preferred_foot || '';
                    document.getElementById('player-jersey-number').value = player.jersey_number || '';
                    document.getElementById('player-height').value = player.height_cm || '';
                    document.getElementById('player-weight').value = player.weight_kg || '';
                    document.getElementById('player-previous-club').value = player.previous_club || '';
                    document.getElementById('player-blood-type').value = player.blood_type || '';
                    document.getElementById('player-phone').value = player.phone || '';
                    document.getElementById('player-email').value = player.email || '';
                    document.getElementById('player-emergency-contact').value = player.emergency_contact || '';
                    document.getElementById('player-notes').value = player.notes || '';
                }
            } catch (error) {
                console.error('Error loading player for edit:', error);
            }
        }

        // Player Form Handler
        document.getElementById('player-detail-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedTeamForManagement) {
                showAlert('team-alert', 'error', 'Önce bir takım seçmelisiniz.');
                return;
            }
            
            const formData = {
                first_name: document.getElementById('player-first-name').value,
                last_name: document.getElementById('player-last-name').value,
                birth_date: document.getElementById('player-birth-date').value,
                nationality: document.getElementById('player-nationality').value,
                primary_position: document.getElementById('player-primary-position').value,
                secondary_positions: document.getElementById('player-secondary-positions').value,
                preferred_foot: document.getElementById('player-preferred-foot').value,
                jersey_number: document.getElementById('player-jersey-number').value || null,
                height_cm: document.getElementById('player-height').value || null,
                weight_kg: document.getElementById('player-weight').value || null,
                previous_club: document.getElementById('player-previous-club').value,
                blood_type: document.getElementById('player-blood-type').value,
                phone: document.getElementById('player-phone').value,
                email: document.getElementById('player-email').value,
                emergency_contact: document.getElementById('player-emergency-contact').value,
                notes: document.getElementById('player-notes').value,
                team_id: selectedTeamForManagement
            };
            
            try {
                let response;
                if (editingPlayerId) {
                    response = await fetch(`/api/players/${editingPlayerId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch('/api/players', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                
                const data = await response.json();
                if (response.ok) {
                    showModalAlert('player-modal-alert', 'success', editingPlayerId ? 'Oyuncu güncellendi.' : 'Oyuncu eklendi.');
                    setTimeout(() => {
                        closePlayerModal();
                        loadTeamPlayers(selectedTeamForManagement);
                        loadUserProfile();
                        loadTeamsTable();
                    }, 1500);
                } else {
                    showModalAlert('player-modal-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Error saving player:', error);
                showModalAlert('player-modal-alert', 'error', 'Kaydetme hatası');
            }
        });

        function showModalAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                if (type !== 'success') container.innerHTML = '';
            }, 5000);
        }

        // Profile Edit Functions
        function toggleProfileEdit() {
            const displays = ['profile-username-display', 'profile-email-display'];
            const inputs = ['profile-username-edit', 'profile-email-edit'];
            const isEditing = document.getElementById('profile-username-edit').style.display !== 'none';
            
            if (isEditing) {
                // Cancel edit
                displays.forEach(id => document.getElementById(id).style.display = 'inline');
                inputs.forEach(id => document.getElementById(id).style.display = 'none');
                document.getElementById('profile-edit-buttons').style.display = 'none';
                document.getElementById('profile-edit-toggle').textContent = 'Düzenle';
            } else {
                // Start edit
                displays.forEach(id => document.getElementById(id).style.display = 'none');
                inputs.forEach(id => document.getElementById(id).style.display = 'block');
                document.getElementById('profile-edit-buttons').style.display = 'block';
                document.getElementById('profile-edit-toggle').textContent = 'İptal';
                
                // Fill edit fields with current values
                document.getElementById('profile-username-edit').value = document.getElementById('profile-username-display').textContent;
                document.getElementById('profile-email-edit').value = document.getElementById('profile-email-display').textContent;
            }
        }

        function cancelProfileEdit() {
            toggleProfileEdit();
        }

        async function saveProfile() {
            const username = document.getElementById('profile-username-edit').value;
            const email = document.getElementById('profile-email-edit').value;
            
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('profile-alert', 'success', data.message);
                    document.getElementById('profile-username-display').textContent = username;
                    document.getElementById('profile-email-display').textContent = email;
                    document.getElementById('user-info').textContent = `Hoşgeldin, ${username}`;
                    document.getElementById('welcome-username').textContent = username;
                    toggleProfileEdit();
                } else {
                    showAlert('profile-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showAlert('profile-alert', 'error', 'Profil güncelleme hatası');
            }
        }

        function togglePasswordEdit() {
            const form = document.getElementById('password-edit-form');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
                document.getElementById('password-edit-toggle').textContent = 'Şifre Değiştir';
                form.querySelectorAll('input').forEach(input => input.value = '');
            } else {
                form.style.display = 'block';
                document.getElementById('password-edit-toggle').textContent = 'İptal';
            }
        }

        function cancelPasswordEdit() {
            togglePasswordEdit();
        }

        async function savePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('profile-alert', 'error', 'Yeni şifreler eşleşmiyor');
                return;
            }
            
            try {
                const response = await fetch('/api/user/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('profile-alert', 'success', data.message);
                    togglePasswordEdit();
                } else {
                    showAlert('profile-alert', 'error', data.error);
                }
            } catch (error) {
                console.error('Password change error:', error);
                showAlert('profile-alert', 'error', 'Şifre değiştirme hatası');
            }
        }

        
        // Player Detail Modal Functions
        let currentPlayerData = null;
        let isEditMode = false;
        
        async function openPlayerDetailModal(playerId) {
            try {
                const response = await fetch(`/api/players/${playerId}`);
                const player = await response.json();
                if (response.ok) {
                    currentPlayerData = player;
                    populatePlayerDetailModal(player);
                    document.getElementById('player-detail-modal').style.display = 'block';
                    showDetailTab('personal');
                } else {
                    showAlert('player-alert', 'error', 'Oyuncu bilgileri yüklenemedi');
                }
            } catch (error) {
                console.error('Error loading player details:', error);
                showAlert('player-alert', 'error', 'Oyuncu bilgileri yüklenirken hata');
            }
        }
        
        function populatePlayerDetailModal(player) {
            // Summary card
            const fullName = `${player.first_name || ''} ${player.last_name || ''}`.trim() || 'İsimsiz Oyuncu';
            document.getElementById('detail-player-name').textContent = fullName;
            document.getElementById('detail-position').textContent = player.primary_position || '-';
            document.getElementById('detail-age').textContent = player.birth_date ? calculateAge(player.birth_date) : '-';
            document.getElementById('detail-jersey').textContent = player.jersey_number || '-';
            document.getElementById('detail-height').textContent = player.height_cm || '-';
            document.getElementById('detail-weight').textContent = player.weight_kg || '-';
            document.getElementById('detail-updated').textContent = new Date(player.created_at).toLocaleDateString('tr-TR');
            document.getElementById('player-detail-title').textContent = `${fullName} - Detayları`;
            
            // Personal info
            document.getElementById('view-first-name').textContent = player.first_name || '-';
            document.getElementById('view-last-name').textContent = player.last_name || '-';
            document.getElementById('view-birth-date').textContent = player.birth_date ? new Date(player.birth_date).toLocaleDateString('tr-TR') : '-';
            document.getElementById('view-nationality').textContent = player.nationality || '-';
            document.getElementById('view-primary-position').textContent = player.primary_position || '-';
            document.getElementById('view-secondary-positions').textContent = player.secondary_positions || '-';
            document.getElementById('view-preferred-foot').textContent = player.preferred_foot || '-';
            document.getElementById('view-jersey-number').textContent = player.jersey_number || '-';
            document.getElementById('view-height-cm').textContent = player.height_cm ? `${player.height_cm} cm` : '-';
            document.getElementById('view-weight-kg').textContent = player.weight_kg ? `${player.weight_kg} kg` : '-';
            document.getElementById('view-blood-type').textContent = player.blood_type || '-';
            document.getElementById('view-current-injury-status').textContent = player.current_injury_status || '-';
            document.getElementById('view-phone').textContent = player.phone || '-';
            document.getElementById('view-email').textContent = player.email || '-';
            document.getElementById('view-emergency-contact').textContent = player.emergency_contact || '-';
            document.getElementById('view-previous-club').textContent = player.previous_club || '-';
            document.getElementById('view-contract-start').textContent = player.contract_start ? new Date(player.contract_start).toLocaleDateString('tr-TR') : '-';
            document.getElementById('view-contract-end').textContent = player.contract_end ? new Date(player.contract_end).toLocaleDateString('tr-TR') : '-';
            document.getElementById('view-club-history').textContent = player.club_history || '-';
            // Injury status will be loaded dynamically when injury modal is opened
            document.getElementById('view-notes').textContent = player.notes || '-';
            
            // Populate edit fields
            document.getElementById('edit-first-name').value = player.first_name || '';
            document.getElementById('edit-last-name').value = player.last_name || '';
            document.getElementById('edit-birth-date').value = player.birth_date || '';
            document.getElementById('edit-nationality').value = player.nationality || '';
            document.getElementById('edit-primary-position').value = player.primary_position || '';
            document.getElementById('edit-secondary-positions').value = player.secondary_positions || '';
            document.getElementById('edit-preferred-foot').value = player.preferred_foot || '';
            document.getElementById('edit-jersey-number').value = player.jersey_number || '';
            document.getElementById('edit-height-cm').value = player.height_cm || '';
            // Weight is managed through separate weight history system
            document.getElementById('edit-blood-type').value = player.blood_type || '';
            document.getElementById('edit-current-injury-status').value = player.current_injury_status || '';
            document.getElementById('edit-phone').value = player.phone || '';
            document.getElementById('edit-email').value = player.email || '';
            document.getElementById('edit-emergency-contact').value = player.emergency_contact || '';
            document.getElementById('edit-previous-club').value = player.previous_club || '';
            document.getElementById('edit-contract-start').value = player.contract_start || '';
            document.getElementById('edit-contract-end').value = player.contract_end || '';
            document.getElementById('edit-club-history').value = player.club_history || '';
            // Injury history is now managed separately
            document.getElementById('edit-notes').value = player.notes || '';
        }
        
        function closePlayerDetailModal() {
            document.getElementById('player-detail-modal').style.display = 'none';
            if (isEditMode) {
                cancelPlayerEdit();
            }
            currentPlayerData = null;
        }
        
        function showDetailTab(tabName) {
            // Hide all tabs and contents
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.detail-tab-content').forEach(content => content.style.display = 'none');
            
            // Show selected tab and content
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`detail-content-${tabName}`).style.display = 'block';
            
            // Load content based on tab
            if (tabName === 'performance' && currentPlayerData) {
                loadPlayerActivities(currentPlayerData.id);
            } else if (tabName === 'stats' && currentPlayerData) {
                loadPlayerStats(currentPlayerData.id);
            } else if (tabName === 'data-entry' && currentPlayerData) {
                // Initialize data entry form
                resetPlayerDetailForm();
            }
        }
        
        function togglePlayerEdit() {
            if (isEditMode) {
                cancelPlayerEdit();
            } else {
                enterEditMode();
            }
        }
        
        function enterEditMode() {
            isEditMode = true;
            document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
            document.getElementById('edit-toggle-btn').textContent = '❌ İptal';
        }
        
        function cancelPlayerEdit() {
            isEditMode = false;
            document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
            document.getElementById('edit-toggle-btn').textContent = '✏️ Düzenle';
            
            // Restore original values
            if (currentPlayerData) {
                populatePlayerDetailModal(currentPlayerData);
            }
        }
        
        async function savePlayerDetails() {
            try {
                const updatedPlayer = {
                    first_name: document.getElementById('edit-first-name').value,
                    last_name: document.getElementById('edit-last-name').value,
                    birth_date: document.getElementById('edit-birth-date').value,
                    nationality: document.getElementById('edit-nationality').value,
                    primary_position: document.getElementById('edit-primary-position').value,
                    secondary_positions: document.getElementById('edit-secondary-positions').value,
                    preferred_foot: document.getElementById('edit-preferred-foot').value,
                    jersey_number: parseInt(document.getElementById('edit-jersey-number').value) || null,
                    height_cm: parseInt(document.getElementById('edit-height-cm').value) || null,
                    // weight_kg: managed through weight history system,
                    blood_type: document.getElementById('edit-blood-type').value,
                    current_injury_status: document.getElementById('edit-current-injury-status').value,
                    phone: document.getElementById('edit-phone').value,
                    email: document.getElementById('edit-email').value,
                    emergency_contact: document.getElementById('edit-emergency-contact').value,
                    previous_club: document.getElementById('edit-previous-club').value,
                    contract_start: document.getElementById('edit-contract-start').value,
                    contract_end: document.getElementById('edit-contract-end').value,
                    club_history: document.getElementById('edit-club-history').value,
                    // injury_history managed separately,
                    notes: document.getElementById('edit-notes').value
                };
                
                const response = await fetch(`/api/players/${currentPlayerData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedPlayer)
                });
                
                const result = await response.json();
                if (response.ok) {
                    currentPlayerData = { ...currentPlayerData, ...updatedPlayer };
                    populatePlayerDetailModal(currentPlayerData);
                    cancelPlayerEdit();
                    loadPlayers(); // Refresh player list
                    showAlert('player-alert', 'success', 'Oyuncu bilgileri güncellendi');
                } else {
                    showAlert('player-alert', 'error', result.error || 'Güncelleme hatası');
                }
            } catch (error) {
                console.error('Error saving player details:', error);
                showAlert('player-alert', 'error', 'Kaydetme hatası');
            }
        }
        
        async function loadPlayerActivities(playerId) {
            try {
                const response = await fetch(`/api/activities?player_id=${playerId}`);
                const activities = await response.json();
                const container = document.getElementById('player-activities-list');
                
                if (response.ok && activities.length > 0) {
                    container.innerHTML = activities.map(activity => `
                        <div style="border: 1px solid #e9ecef; padding: 20px; margin-bottom: 15px; border-radius: 8px; background: ${activity.activity_type === 'match' ? 'linear-gradient(135deg, #ff6b6b, #ffa726)' : 'linear-gradient(135deg, #4ecdc4, #44a08d)'}; color: white; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0.8;">
                                <button onclick="editActivity(${activity.id})" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Düzenle">✏️</button>
                                <button onclick="deleteActivity(${activity.id})" style="background: rgba(255,0,0,0.3); border: none; color: white; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Sil">🗑️</button>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-right: 70px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                        ${activity.activity_type === 'training' ? 'ANTRENMAN' : 'MAÇ'}
                                    </span>
                                    <span style="font-weight: bold; font-size: 16px;">
                                        ${new Date(activity.date).toLocaleDateString('tr-TR')}
                                        ${activity.activity_time ? ` - ${activity.activity_time}` : ''}
                                    </span>
                                </div>
                                ${activity.duration_minutes ? `<span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">${activity.duration_minutes} dk</span>` : ''}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 10px;">
                                ${activity.total_distance_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Toplam Mesafe</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.total_distance_m} m</div>
                                    </div>
                                ` : ''}
                                ${activity.high_speed_16kmh_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Hız 16+ km/h</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.high_speed_16kmh_m} m</div>
                                    </div>
                                ` : ''}
                                ${activity.high_speed_18kmh_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Hız 18+ km/h</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.high_speed_18kmh_m} m</div>
                                    </div>
                                ` : ''}
                                ${activity.high_speed_20kmh_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Hız 20+ km/h</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.high_speed_20kmh_m} m</div>
                                    </div>
                                ` : ''}
                                ${activity.sprint_24kmh_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Sprint 24+ km/h</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.sprint_24kmh_m} m</div>
                                    </div>
                                ` : ''}
                                ${activity.acc_decc_count ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">AccDecc Sayısı</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.acc_decc_count}</div>
                                    </div>
                                ` : ''}
                                ${activity.high_metabolic_power_m ? `
                                    <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; opacity: 0.9;">Metabolik Güç</div>
                                        <div style="font-weight: bold; font-size: 14px;">${activity.high_metabolic_power_m} m</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${activity.notes ? `<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; font-style: italic; margin-top: 10px; font-size: 13px;">"${activity.notes}"</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading">Bu oyuncu için henüz aktivite verisi yok.</div>';
                }
            } catch (error) {
                document.getElementById('player-activities-list').innerHTML = '<div class="loading">Aktiviteler yüklenemedi.</div>';
            }
        }
        
        async function loadPlayerStats(playerId) {
            try {
                const response = await fetch(`/api/players/${playerId}/statistics`);
                const stats = await response.json();
                const container = document.getElementById('player-stats-summary');
                
                if (response.ok && stats) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                                <h5 style="margin: 0 0 15px 0; font-size: 16px;">Genel İstatistikler</h5>
                                <div style="font-size: 14px; line-height: 1.6;">
                                    <div><strong>Toplam Aktivite:</strong> ${stats.general_stats.total_activities}</div>
                                    <div><strong>Antrenman:</strong> ${stats.general_stats.training_count}</div>
                                    <div><strong>Maç:</strong> ${stats.general_stats.match_count}</div>
                                    <div><strong>Son Aktivite:</strong> ${stats.general_stats.last_activity_date ? new Date(stats.general_stats.last_activity_date).toLocaleDateString('tr-TR') : 'Yok'}</div>
                                </div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                                <h5 style="margin: 0 0 15px 0; font-size: 16px;">Ortalama Performans</h5>
                                <div style="font-size: 14px; line-height: 1.6;">
                                    <div><strong>Süre:</strong> ${stats.averages.duration_minutes} dk</div>
                                    <div><strong>Mesafe:</strong> ${stats.averages.total_distance_m} m</div>
                                    <div><strong>Yüksek Hız 20+:</strong> ${stats.averages.high_speed_20kmh_m} m</div>
                                    <div><strong>Sprint 24+:</strong> ${stats.averages.sprint_24kmh_m} m</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px;">
                            <h5 style="margin: 0 0 20px 0; color: #333;">Antrenman vs Maç Karşılaştırması</h5>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-weight: bold; color: #666; margin-bottom: 8px;">Süre (dk)</div>
                                    <div style="background: #4CAF50; color: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                        <div style="font-size: 12px;">Antrenman</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.training.duration}</div>
                                    </div>
                                    <div style="background: #FF5722; color: white; padding: 8px; border-radius: 4px;">
                                        <div style="font-size: 12px;">Maç</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.match.duration}</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: #666; margin-bottom: 8px;">Mesafe (m)</div>
                                    <div style="background: #4CAF50; color: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                        <div style="font-size: 12px;">Antrenman</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.training.distance}</div>
                                    </div>
                                    <div style="background: #FF5722; color: white; padding: 8px; border-radius: 4px;">
                                        <div style="font-size: 12px;">Maç</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.match.distance}</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: #666; margin-bottom: 8px;">Yüksek Hız (m)</div>
                                    <div style="background: #4CAF50; color: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                        <div style="font-size: 12px;">Antrenman</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.training.high_speed}</div>
                                    </div>
                                    <div style="background: #FF5722; color: white; padding: 8px; border-radius: 4px;">
                                        <div style="font-size: 12px;">Maç</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.match.high_speed}</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: #666; margin-bottom: 8px;">Sprint (m)</div>
                                    <div style="background: #4CAF50; color: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                                        <div style="font-size: 12px;">Antrenman</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.training.sprint}</div>
                                    </div>
                                    <div style="background: #FF5722; color: white; padding: 8px; border-radius: 4px;">
                                        <div style="font-size: 12px;">Maç</div>
                                        <div style="font-weight: bold;">${stats.training_vs_match.match.sprint}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: #333;">Detaylı Ortalamalar</h6>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 13px;">
                                <div><strong>16 km/h+:</strong> ${stats.averages.high_speed_16kmh_m} m</div>
                                <div><strong>18 km/h+:</strong> ${stats.averages.high_speed_18kmh_m} m</div>
                                <div><strong>AccDecc:</strong> ${stats.averages.acc_decc_count}</div>
                                <div><strong>Metabolik Güç:</strong> ${stats.averages.metabolic_power_m} m</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="loading">İstatistik verileri yüklenemedi.</div>';
                }
            } catch (error) {
                document.getElementById('player-stats-summary').innerHTML = '<div class="loading">İstatistikler yüklenemedi.</div>';
            }
        }
        
        // Weight History Modal Functions
        function showWeightHistoryModal() {
            if (!currentPlayerData) return;
            
            const fullName = `${currentPlayerData.first_name || ''} ${currentPlayerData.last_name || ''}`.trim();
            document.getElementById('weight-history-title').textContent = `${fullName} - Kilo Geçmişi`;
            document.getElementById('weight-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('weight-history-modal').style.display = 'block';
            loadWeightHistory();
        }
        
        function closeWeightHistoryModal() {
            document.getElementById('weight-history-modal').style.display = 'none';
        }
        
        async function loadWeightHistory() {
            if (!currentPlayerData) return;
            
            try {
                const response = await fetch(`/api/players/${currentPlayerData.id}/weight-measurements`);
                const weights = await response.json();
                
                const container = document.getElementById('weight-history-table');
                
                if (weights.length > 0) {
                    let html = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kilo (kg)</th>
                                    <th>Notlar</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    weights.forEach(weight => {
                        html += `
                            <tr>
                                <td>${new Date(weight.measurement_date).toLocaleDateString('tr-TR')}</td>
                                <td style="font-weight: bold; color: #007bff;">${weight.weight_kg} kg</td>
                                <td>${weight.notes || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Henüz kilo ölçümü kaydedilmemiş.</div>';
                }
            } catch (error) {
                console.error('Error loading weight history:', error);
                document.getElementById('weight-history-table').innerHTML = '<div style="color: red;">Kilo geçmişi yüklenemedi.</div>';
            }
        }
        
        // Weight Form Handler
        document.getElementById('weight-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPlayerData) return;
            
            const data = {
                weight_kg: parseFloat(document.getElementById('weight-value').value),
                measurement_date: document.getElementById('weight-date').value,
                notes: document.getElementById('weight-notes').value || ''
            };
            
            try {
                const response = await fetch(`/api/players/${currentPlayerData.id}/weight-measurements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showWeightAlert('success', 'Kilo ölçümü başarıyla kaydedildi!');
                    document.getElementById('weight-form').reset();
                    document.getElementById('weight-date').value = new Date().toISOString().split('T')[0];
                    loadWeightHistory();
                    
                    // Update current weight display
                    document.getElementById('detail-weight').textContent = data.weight_kg;
                    document.getElementById('view-weight-kg').textContent = data.weight_kg;
                } else {
                    showWeightAlert('error', result.error || 'Kilo ölçümü kaydedilemedi');
                }
            } catch (error) {
                console.error('Error adding weight measurement:', error);
                showWeightAlert('error', 'Sunucu hatası oluştu');
            }
        });
        
        function showWeightAlert(type, message) {
            const container = document.getElementById('weight-modal-alert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            container.style.display = 'block';
            setTimeout(() => {
                if (type !== 'success') container.style.display = 'none';
            }, 5000);
        }
        
        // Injury History Modal Functions
        function showInjuryHistoryModal() {
            if (!currentPlayerData) return;
            
            const fullName = `${currentPlayerData.first_name || ''} ${currentPlayerData.last_name || ''}`.trim();
            document.getElementById('injury-history-title').textContent = `${fullName} - Sakatlık Geçmişi`;
            document.getElementById('injury-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('injury-history-modal').style.display = 'block';
            loadInjuryHistory();
        }
        
        function closeInjuryHistoryModal() {
            document.getElementById('injury-history-modal').style.display = 'none';
        }
        
        async function loadInjuryHistory() {
            if (!currentPlayerData) return;
            
            try {
                const response = await fetch(`/api/players/${currentPlayerData.id}/injury-records`);
                const injuries = await response.json();
                
                const container = document.getElementById('injury-history-table');
                
                if (injuries.length > 0) {
                    let activeInjuries = injuries.filter(i => i.status === 'active');
                    
                    // Update injury status display
                    if (activeInjuries.length > 0) {
                        document.getElementById('view-injury-status').textContent = 
                            `${activeInjuries.length} aktif sakatlık: ${activeInjuries.map(i => i.injury_type).join(', ')}`;
                    } else {
                        document.getElementById('view-injury-status').textContent = 'Aktif sakatlık bulunmuyor';
                    }
                    
                    let html = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tür</th>
                                    <th>Durum</th>
                                    <th>İyileşme</th>
                                    <th>Açıklama</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    injuries.forEach(injury => {
                        const statusClass = injury.status === 'active' ? 'color: red; font-weight: bold;' : 'color: green;';
                        const recoveryDate = injury.recovery_date ? new Date(injury.recovery_date).toLocaleDateString('tr-TR') : '-';
                        
                        html += `
                            <tr>
                                <td>${new Date(injury.injury_date).toLocaleDateString('tr-TR')}</td>
                                <td style="font-weight: bold;">${injury.injury_type}</td>
                                <td style="${statusClass}">${injury.status === 'active' ? 'Aktif' : 'İyileşmiş'}</td>
                                <td>${recoveryDate}</td>
                                <td>${injury.description || '-'}</td>
                                <td>
                                    ${injury.status === 'active' ? 
                                        `<button class="btn btn-sm" onclick="markInjuryRecovered(${injury.id})" style="background: #28a745; color: white;">İyileşti</button>` 
                                        : '-'
                                    }
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Henüz sakatlık kaydı bulunmuyor.</div>';
                    document.getElementById('view-injury-status').textContent = 'Aktif sakatlık bulunmuyor';
                }
            } catch (error) {
                console.error('Error loading injury history:', error);
                document.getElementById('injury-history-table').innerHTML = '<div style="color: red;">Sakatlık geçmişi yüklenemedi.</div>';
            }
        }
        
        // Injury Form Handler
        document.getElementById('injury-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPlayerData) return;
            
            const data = {
                injury_date: document.getElementById('injury-date').value,
                injury_type: document.getElementById('injury-type').value,
                description: document.getElementById('injury-description').value || '',
                recovery_date: document.getElementById('injury-recovery-date').value || null,
                status: document.getElementById('injury-status').value
            };
            
            try {
                const response = await fetch(`/api/players/${currentPlayerData.id}/injury-records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showInjuryAlert('success', 'Sakatlık kaydı başarıyla eklendi!');
                    document.getElementById('injury-form').reset();
                    document.getElementById('injury-date').value = new Date().toISOString().split('T')[0];
                    document.getElementById('injury-status').value = 'active';
                    loadInjuryHistory();
                } else {
                    showInjuryAlert('error', result.error || 'Sakatlık kaydedilemedi');
                }
            } catch (error) {
                console.error('Error adding injury record:', error);
                showInjuryAlert('error', 'Sunucu hatası oluştu');
            }
        });
        
        async function markInjuryRecovered(injuryId) {
            if (!currentPlayerData) return;
            
            const recoveryDate = prompt('İyileşme tarihi (YYYY-MM-DD formatında):');
            if (!recoveryDate) return;
            
            try {
                const response = await fetch(`/api/players/${currentPlayerData.id}/injury-records/${injuryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'recovered',
                        recovery_date: recoveryDate
                    })
                });
                
                if (response.ok) {
                    loadInjuryHistory();
                } else {
                    alert('Sakatlık durumu güncellenemedi');
                }
            } catch (error) {
                console.error('Error updating injury:', error);
                alert('Sunucu hatası oluştu');
            }
        }
        
        function showInjuryAlert(type, message) {
            const container = document.getElementById('injury-modal-alert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            container.style.display = 'block';
            setTimeout(() => {
                if (type !== 'success') container.style.display = 'none';
            }, 5000);
        }
        
        // Activity Edit/Delete Functions
        let currentEditingActivity = null;
        
        async function editActivity(activityId) {
            try {
                // Get current activities from the loaded data
                const response = await fetch(`/api/activities?player_id=${currentPlayerData.id}`);
                const activities = await response.json();
                
                const activity = activities.find(a => a.id === activityId);
                if (!activity) {
                    alert('Aktivite bulunamadı');
                    return;
                }
                
                currentEditingActivity = activity;
                
                // Populate edit form
                document.getElementById('edit-activity-id').value = activity.id;
                document.getElementById('edit-activity-date').value = activity.date;
                document.getElementById('edit-activity-time').value = activity.activity_time || '';
                document.getElementById('edit-activity-type').value = activity.activity_type;
                document.getElementById('edit-duration').value = activity.duration_minutes || '';
                document.getElementById('edit-distance').value = activity.total_distance_m || '';
                document.getElementById('edit-hs16').value = activity.high_speed_16kmh_m || '';
                document.getElementById('edit-hs18').value = activity.high_speed_18kmh_m || '';
                document.getElementById('edit-hs20').value = activity.high_speed_20kmh_m || '';
                document.getElementById('edit-hs24').value = activity.sprint_24kmh_m || '';
                document.getElementById('edit-sprint-count').value = activity.sprint_count || '';
                document.getElementById('edit-acc-count').value = activity.acc_count || '';
                document.getElementById('edit-dec-count').value = activity.dec_count || '';
                document.getElementById('edit-metabolic-power').value = activity.metabolic_power || '';
                document.getElementById('edit-activity-notes').value = activity.notes || '';
                
                // Show modal
                document.getElementById('activity-edit-title').textContent = 
                    `${activity.activity_type === 'training' ? 'Antrenman' : 'Maç'} Düzenle - ${new Date(activity.date).toLocaleDateString('tr-TR')}`;
                document.getElementById('activity-edit-modal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading activity for edit:', error);
                alert('Aktivite yüklenirken hata oluştu');
            }
        }
        
        async function deleteActivity(activityId) {
            if (!confirm('Bu aktiviteyi silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/activities/${activityId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Refresh activities list
                    loadPlayerActivities(currentPlayerData.id);
                    // Refresh stats if visible
                    if (document.getElementById('tab-stats').classList.contains('active')) {
                        loadPlayerStats(currentPlayerData.id);
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Aktivite silinirken hata oluştu');
                }
            } catch (error) {
                console.error('Error deleting activity:', error);
                alert('Sunucu hatası oluştu');
            }
        }
        
        function closeActivityEditModal() {
            document.getElementById('activity-edit-modal').style.display = 'none';
            document.getElementById('activity-edit-modal-alert').style.display = 'none';
            currentEditingActivity = null;
        }
        
        function showActivityEditAlert(type, message) {
            const container = document.getElementById('activity-edit-modal-alert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            container.style.display = 'block';
            setTimeout(() => {
                if (type !== 'success') container.style.display = 'none';
            }, 5000);
        }
        
        // Activity Edit Form Handler
        document.getElementById('activity-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditingActivity) {
                showActivityEditAlert('error', 'Düzenlenecek aktivite bulunamadı');
                return;
            }
            
            const toInt = v => {
                const parsed = parseInt(v, 10);
                return isNaN(parsed) ? null : parsed;
            };
            
            const data = {
                date: document.getElementById('edit-activity-date').value,
                activity_time: document.getElementById('edit-activity-time').value || null,
                activity_type: document.getElementById('edit-activity-type').value,
                duration_minutes: toInt(document.getElementById('edit-duration').value),
                total_distance_m: toInt(document.getElementById('edit-distance').value),
                high_speed_16kmh_m: toInt(document.getElementById('edit-hs16').value),
                high_speed_18kmh_m: toInt(document.getElementById('edit-hs18').value),
                high_speed_20kmh_m: toInt(document.getElementById('edit-hs20').value),
                sprint_24kmh_m: toInt(document.getElementById('edit-hs24').value),
                sprint_count: toInt(document.getElementById('edit-sprint-count').value),
                acc_count: toInt(document.getElementById('edit-acc-count').value),
                dec_count: toInt(document.getElementById('edit-dec-count').value),
                metabolic_power: parseFloat(document.getElementById('edit-metabolic-power').value) || null,
                notes: document.getElementById('edit-activity-notes').value || null
            };
            
            try {
                const response = await fetch(`/api/activities/${currentEditingActivity.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showActivityEditAlert('success', 'Aktivite başarıyla güncellendi!');
                    setTimeout(() => {
                        closeActivityEditModal();
                        // Refresh activities and stats
                        loadPlayerActivities(currentPlayerData.id);
                        if (document.getElementById('tab-stats').classList.contains('active')) {
                            loadPlayerStats(currentPlayerData.id);
                        }
                    }, 1500);
                } else {
                    showActivityEditAlert('error', result.error || 'Aktivite güncellenirken hata oluştu');
                }
            } catch (error) {
                console.error('Error updating activity:', error);
                showActivityEditAlert('error', 'Sunucu hatası oluştu');
            }
        });
        
    </script>
</body>
</html>
